<!DOCTYPE html>
     2	<html lang="en">
     3	<head>
     4	    <meta charset="UTF-8">
     5	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     6	    <title>Lush Labs Suite - Manufacturing Operations</title>
     7	    
     8	    <!-- TailwindCSS CDN with Custom Configuration -->
     9	    <script src="https://cdn.tailwindcss.com"></script>
    10	    <script>
    11	        tailwind.config = {
    12	            theme: {
    13	                extend: {
    14	                    colors: {
    15	                        sage: {
    16	                            50: '#f6f7f6',
    17	                            100: '#e3e8e3',
    18	                            200: '#c7d2c7',
    19	                            300: '#a3b3a3',
    20	                            400: '#7a927a',
    21	                            500: '#5c7a5c',
    22	                            600: '#4a6b4a',
    23	                            700: '#3d563d',
    24	                            800: '#334533',
    25	                            900: '#2d3a2d',
    26	                        },
    27	                        cream: {
    28	                            50: '#fefdf9',
    29	                            100: '#fefcf3',
    30	                            200: '#fef7e7',
    31	                            300: '#feedd5',
    32	                            400: '#fde1a3',
    33	                            500: '#fbcd6f',
    34	                            600: '#f7b955',
    35	                            700: '#f3a43d',
    36	                            800: '#ee8e2d',
    37	                            900: '#e07c1e',
    38	                        }
    39	                    }
    40	                }
    41	            }
    42	        }
    43	    </script>
    44	    
    45	    <!-- Chart.js for Analytics -->
    46	    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    47	    
    48	    <!-- Font Awesome Icons -->
    49	    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    50	    
    51	    <!-- Google Fonts -->
    52	    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    53	    
    54	    <!-- Neon Database Configuration -->
    55	    <script>
    56	        // Neon Database Configuration for Lush Labs Suite
    57	        console.log('ðŸŽ¯ Initializing Neon Database integration for Lush Labs Suite');
    58	        
    59	        // Override fetch to use Netlify Functions for database access
    60	        const originalFetch = window.fetch;
    61	        window.fetch = function(url, options = {}) {
    62	            // Check if this is a table API call
    63	            if (url.startsWith('/tables/') || url.startsWith('tables/')) {
    64	                let tableName = url.replace('/tables/', '').replace('tables/', '');
    65	                let recordId = null;
    66	                
    67	                if (tableName.includes('/')) {
    68	                    const parts = tableName.split('/');
    69	                    tableName = parts[0];
    70	                    recordId = parts[1];
    71	                }
    72	                
    73	                let queryParams = '';
    74	                if (url.includes('?')) {
    75	                    queryParams = url.split('?')[1];
    76	                    tableName = tableName.split('?')[0];
    77	                }
    78	                
    79	                // Use Netlify Functions for database access
    80	                let neonUrl = `/.netlify/functions/db-query/${tableName}`;
    81	                if (recordId) {
    82	                    neonUrl += `/${recordId}`;
    83	                }
    84	                if (queryParams) {
    85	                    neonUrl += `?${queryParams}`;
    86	                }
    87	                
    88	                console.log(`Neon DB API: ${options.method || 'GET'} ${neonUrl}`);
    89	                
    90	                return originalFetch(neonUrl, {
    91	                    ...options,
    92	                    headers: {
    93	                        'Content-Type': 'application/json',
    94	                        ...options.headers
    95	                    }
    96	                }).then(response => {
    97	                    return response.json().then(data => {
    98	                        // Handle the response format
    99	                        return {
   100	                            ok: response.ok,
   101	                            status: response.status,
   102	                            json: () => Promise.resolve(data)
   103	                        };
   104	                    });
   105	                });
   106	            }
   107	            
   108	            // Handle auth login
   109	            if (url.includes('/auth/login') || url.includes('auth/login')) {
   110	                const credentials = JSON.parse(options.body);
   111	                if ((credentials.email === 'admin@luxebeauty.com' && credentials.password === 'admin123') ||
   112	                    (credentials.email === 'hello@starseednatural.com' && credentials.password === 'starseed123')) {
   113	                    return Promise.resolve({
   114	                        ok: true,
   115	                        json: () => Promise.resolve({
   116	                            success: true,
   117	                            user: {
   118	                                id: 'user-id',
   119	                                email: credentials.email,
   120	                                name: credentials.email.includes('admin') ? 'System Administrator' : 'Star Seed Natural',
   121	                                role: credentials.email.includes('admin') ? 'Admin' : 'Client User',
   122	                                client_id: credentials.email.includes('starseed') ? 'SSN001' : null,
   123	                                tenant_id: 'luxebeauty_001'
   124	                            }
   125	                        })
   126	                    });
   127	                } else {
   128	                    return Promise.resolve({
   129	                        ok: false,
   130	                        json: () => Promise.resolve({ success: false, error: 'Invalid credentials' })
   131	                    });
   132	                }
   133	            }
   134	            
   135	            return originalFetch(url, options);
   136	        };
   137	        
   138	        console.log('ðŸš€ Neon Database integration configured for Lush Labs Suite');
   139	    </script>
   140	    
   141	    <style>
   142	        body { 
   143	            font-family: 'Inter', sans-serif; 
   144	            background: linear-gradient(135deg, #f6f7f6 0%, #e3e8e3 100%);
   145	        }
   146	        .manufacturing-bg {
   147	            background: linear-gradient(135deg, #f6f7f6 0%, #e3e8e3 50%, #fefdf9 100%);
   148	        }
   149	        .glass-effect {
   150	            backdrop-filter: blur(10px);
   151	            background: rgba(255, 255, 255, 0.8);
   152	            border: 1px solid rgba(255, 255, 255, 0.2);
   153	        }
   154	    </style>
   155	</head>
   156	
   157	<body class="manufacturing-bg min-h-screen">
   158	    <!-- Navigation Header -->
   159	    <nav class="glass-effect shadow-lg">
   160	        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
   161	            <div class="flex justify-between h-16">
   162	                <div class="flex items-center">
   163	                    <div class="flex-shrink-0 flex items-center">
   164	                        <i class="fas fa-industry text-2xl text-sage-600 mr-3"></i>
   165	                        <h1 class="text-xl font-bold text-gray-900">Lush Labs Suite</h1>
   166	                    </div>
   167	                </div>
   168	                <div class="flex items-center space-x-4">
   169	                    <div id="userInfo" class="hidden text-sm text-gray-700">
   170	                        <span id="userName"></span>
   171	                    </div>
   172	                    <button id="logoutBtn" onclick="logout()" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
   173	                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
   174	                    </button>
   175	                </div>
   176	            </div>
   177	        </div>
   178	    </nav>
   179	
   180	    <!-- Login Section -->
   181	    <div id="loginSection" class="flex items-center justify-center min-h-screen p-4">
   182	        <div class="glass-effect rounded-2xl shadow-2xl p-8 max-w-md w-full">
   183	            <div class="text-center mb-8">
   184	                <i class="fas fa-industry text-4xl text-sage-600 mb-4"></i>
   185	                <h2 class="text-3xl font-bold text-gray-900 mb-2">Manufacturing Operations Suite</h2>
   186	                <p class="text-gray-600">Advanced formulation management and production control</p>
   187	                <div class="mt-4 flex items-center justify-center space-x-2 text-sm text-green-600">
   188	                    <i class="fas fa-database"></i>
   189	                    <span>Connected to Neon PostgreSQL</span>
   190	                </div>
   191	            </div>
   192	            
   193	            <div class="space-y-4">
   194	                <button onclick="loginAs('admin')" class="w-full bg-sage-600 hover:bg-sage-700 text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105">
   195	                    <i class="fas fa-user-shield mr-2"></i>
   196	                    Manufacturing Administrator
   197	                </button>
   198	                <button onclick="loginAs('client')" class="w-full bg-cream-500 hover:bg-cream-600 text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105">
   199	                    <i class="fas fa-building mr-2"></i>
   200	                    Star Seed Natural Portal
   201	                </button>
   202	            </div>
   203	            
   204	            <div class="mt-6 text-center text-xs text-gray-500 space-y-1">
   205	                <p>Admin: admin@luxebeauty.com / admin123</p>
   206	                <p>Client: hello@starseednatural.com / starseed123</p>
   207	            </div>
   208	        </div>
   209	    </div>
   210	
   211	    <!-- Main Dashboard -->
   212	    <div id="dashboardSection" class="hidden">
   213	        <!-- Main Content Area -->
   214	        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
   215	            
   216	            <!-- Quick Stats -->
   217	            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
   218	                <div class="glass-effect rounded-xl p-6 text-center">
   219	                    <i class="fas fa-flask text-3xl text-sage-600 mb-2"></i>
   220	                    <h3 class="text-lg font-semibold text-gray-900">Active Formulations</h3>
   221	                    <p class="text-2xl font-bold text-sage-600" id="formulationCount">Loading...</p>
   222	                </div>
   223	                <div class="glass-effect rounded-xl p-6 text-center">
   224	                    <i class="fas fa-boxes text-3xl text-cream-600 mb-2"></i>
   225	                    <h3 class="text-lg font-semibold text-gray-900">Products in Stock</h3>
   226	                    <p class="text-2xl font-bold text-cream-600" id="productCount">Loading...</p>
   227	                </div>
   228	                <div class="glass-effect rounded-xl p-6 text-center">
   229	                    <i class="fas fa-calculator text-3xl text-blue-600 mb-2"></i>
   230	                    <h3 class="text-lg font-semibold text-gray-900">Batch Calculations</h3>
   231	                    <p class="text-2xl font-bold text-blue-600" id="batchCount">Loading...</p>
   232	                </div>
   233	                <div class="glass-effect rounded-xl p-6 text-center">
   234	                    <i class="fas fa-industry text-3xl text-purple-600 mb-2"></i>
   235	                    <h3 class="text-lg font-semibold text-gray-900">System Status</h3>
   236	                    <p class="text-xl font-bold text-green-600">Operational</p>
   237	                </div>
   238	            </div>
   239	
   240	            <!-- Main Module Grid -->
   241	            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
   242	                
   243	                <!-- Formulation Calculator Module -->
   244	                <div class="glass-effect rounded-2xl p-8 shadow-xl">
   245	                    <div class="flex items-center mb-6">
   246	                        <i class="fas fa-calculator text-2xl text-sage-600 mr-3"></i>
   247	                        <h2 class="text-2xl font-bold text-gray-900">Formulation Calculator</h2>
   248	                    </div>
   249	                    
   250	                    <p class="text-gray-600 mb-6">Calculate precise ingredient quantities with automatic batch scaling and cost analysis.</p>
   251	                    
   252	                    <div class="space-y-4">
   253	                        <div>
   254	                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Product</label>
   255	                            <select id="productSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sage-500 focus:border-sage-500">
   256	                                <option value="">Choose Star Seed Product...</option>
   257	                                <option value="SSN-FC-20">Forest Cream 20ml</option>
   258	                                <option value="SSN-FC-50">Forest Cream 50ml</option>
   259	                                <option value="SSN-MC-20">Moon Cream 20ml</option>
   260	                                <option value="SSN-MC-50">Moon Cream 50ml</option>
   261	                                <option value="SSN-SS-12">Star Serum 12ml</option>
   262	                                <option value="SSN-SS-18">Star Serum 18ml</option>
   263	                            </select>
   264	                        </div>
   265	                        
   266	                        <div>
   267	                            <label class="block text-sm font-medium text-gray-700 mb-2">Batch Size (kg)</label>
   268	                            <input type="number" id="batchSize" step="0.1" min="0.1" 
   269	                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sage-500 focus:border-sage-500"
   270	                                   placeholder="Enter target batch size">
   271	                        </div>
   272	                        
   273	                        <button onclick="calculateBatch()" class="w-full bg-gradient-to-r from-sage-600 to-sage-700 hover:from-sage-700 hover:to-sage-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105">
   274	                            <i class="fas fa-calculator mr-2"></i>Calculate Batch & Generate Number
   275	                        </button>
   276	                    </div>
   277	                    
   278	                    <!-- Calculation Results -->
   279	                    <div id="calculationResults" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
   280	                        <h4 class="font-semibold text-green-800 mb-3">
   281	                            <i class="fas fa-check-circle mr-2"></i>Calculation Complete
   282	                        </h4>
   283	                        <div id="calculationDetails"></div>
   284	                        <button onclick="printFormulation()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
   285	                            <i class="fas fa-print mr-1"></i>Print Formulation Sheet
   286	                        </button>
   287	                    </div>
   288	                </div>
   289	
   290	                <!-- Inventory Management Module -->
   291	                <div class="glass-effect rounded-2xl p-8 shadow-xl">
   292	                    <div class="flex items-center mb-6">
   293	                        <i class="fas fa-warehouse text-2xl text-cream-600 mr-3"></i>
   294	                        <h2 class="text-2xl font-bold text-gray-900">Star Seed Inventory</h2>
   295	                    </div>
   296	                    
   297	                    <p class="text-gray-600 mb-6">Real-time inventory tracking with automated stock alerts and reorder notifications.</p>
   298	                    
   299	                    <div id="inventoryList" class="space-y-3 mb-6">
   300	                        <!-- Inventory items will be loaded here -->
   301	                    </div>
   302	                    
   303	                    <div class="flex space-x-3">
   304	                        <button onclick="loadInventory()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
   305	                            <i class="fas fa-sync mr-1"></i>Refresh Data
   306	                        </button>
   307	                        <button onclick="exportInventory()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm">
   308	                            <i class="fas fa-download mr-1"></i>Export CSV
   309	                        </button>
   310	                    </div>
   311	                </div>
   312	
   313	                <!-- Production Analytics -->
   314	                <div class="glass-effect rounded-2xl p-8 shadow-xl">
   315	                    <div class="flex items-center mb-6">
   316	                        <i class="fas fa-chart-line text-2xl text-blue-600 mr-3"></i>
   317	                        <h2 class="text-2xl font-bold text-gray-900">Production Analytics</h2>
   318	                    </div>
   319	                    
   320	                    <div class="mb-4">
   321	                        <canvas id="productionChart" width="400" height="200"></canvas>
   322	                    </div>
   323	                    
   324	                    <div class="grid grid-cols-2 gap-4 text-sm">
   325	                        <div class="text-center p-3 bg-blue-50 rounded-lg">
   326	                            <div class="font-semibold text-blue-800">This Month</div>
   327	                            <div class="text-2xl font-bold text-blue-600">247</div>
   328	                            <div class="text-blue-600">Units Produced</div>
   329	                        </div>
   330	                        <div class="text-center p-3 bg-green-50 rounded-lg">
   331	                            <div class="font-semibold text-green-800">Efficiency</div>
   332	                            <div class="text-2xl font-bold text-green-600">94.8%</div>
   333	                            <div class="text-green-600">Target Achievement</div>
   334	                        </div>
   335	                    </div>
   336	                </div>
   337	
   338	                <!-- Database Management -->
   339	                <div class="glass-effect rounded-2xl p-8 shadow-xl">
   340	                    <div class="flex items-center mb-6">
   341	                        <i class="fas fa-database text-2xl text-purple-600 mr-3"></i>
   342	                        <h2 class="text-2xl font-bold text-gray-900">Database Management</h2>
   343	                    </div>
   344	                    
   345	                    <p class="text-gray-600 mb-6">Monitor database connectivity and perform system diagnostics.</p>
   346	                    
   347	                    <div class="grid grid-cols-2 gap-3 mb-6">
   348	                        <button onclick="testConnection()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-3 rounded-lg text-sm">
   349	                            <i class="fas fa-plug mr-1"></i>Test Connection
   350	                        </button>
   351	                        <button onclick="loadProducts()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-lg text-sm">
   352	                            <i class="fas fa-box mr-1"></i>Load Products
   353	                        </button>
   354	                        <button onclick="loadFormulations()" class="bg-teal-600 hover:bg-teal-700 text-white py-2 px-3 rounded-lg text-sm">
   355	                            <i class="fas fa-flask mr-1"></i>Load Formulations
   356	                        </button>
   357	                        <button onclick="createTestBatch()" class="bg-orange-600 hover:bg-orange-700 text-white py-2 px-3 rounded-lg text-sm">
   358	                            <i class="fas fa-plus mr-1"></i>Test Batch
   359	                        </button>
   360	                    </div>
   361	                    
   362	                    <div id="dbResults" class="p-3 bg-gray-50 rounded-lg text-sm font-mono">
   363	                        <span class="text-gray-600">Database status: Ready for operations...</span>
   364	                    </div>
   365	                </div>
   366	            </div>
   367	
   368	            <!-- Order Management Section -->
   369	            <div class="mt-8">
   370	                <div class="glass-effect rounded-2xl p-8 shadow-xl">
   371	                    <div class="flex items-center justify-between mb-6">
   372	                        <div class="flex items-center">
   373	                            <i class="fas fa-shopping-cart text-2xl text-green-600 mr-3"></i>
   374	                            <h2 class="text-2xl font-bold text-gray-900">Order Management System</h2>
   375	                        </div>
   376	                        <button onclick="openOrderManagement()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
   377	                            <i class="fas fa-plus mr-2"></i>Create Order
   378	                        </button>
   379	                    </div>
   380	                    
   381	                    <p class="text-gray-600 mb-6">Complete end-to-end order processing from creation to invoicing and delivery.</p>
   382	                    
   383	                    <div class="grid grid-cols-4 gap-4 mb-6">
   384	                        <div class="text-center p-4 bg-blue-50 rounded-lg">
   385	                            <div class="text-2xl font-bold text-blue-600" id="totalOrdersCount">0</div>
   386	                            <div class="text-sm text-gray-600">Total Orders</div>
   387	                        </div>
   388	                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
   389	                            <div class="text-2xl font-bold text-yellow-600" id="pendingOrdersCount">0</div>
   390	                            <div class="text-sm text-gray-600">Pending</div>
   391	                        </div>
   392	                        <div class="text-center p-4 bg-green-50 rounded-lg">
   393	                            <div class="text-2xl font-bold text-green-600" id="completedOrdersCount">0</div>
   394	                            <div class="text-sm text-gray-600">Completed</div>
   395	                        </div>
   396	                        <div class="text-center p-4 bg-purple-50 rounded-lg">
   397	                            <div class="text-2xl font-bold text-purple-600" id="revenueTotal">Â£0</div>
   398	                            <div class="text-sm text-gray-600">Revenue</div>
   399	                        </div>
   400	                    </div>
   401	
   402	                    <div class="flex space-x-3">
   403	                        <button onclick="loadOrderStats()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
   404	                            <i class="fas fa-sync mr-1"></i>Refresh Orders
   405	                        </button>
   406	                        <button onclick="openWixIntegration()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-sm">
   407	                            <i class="fas fa-store mr-1"></i>Sync Wix Orders
   408	                        </button>
   409	                        <button onclick="generateBulkInvoices()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm">
   410	                            <i class="fas fa-file-invoice mr-1"></i>Bulk Invoices
   411	                        </button>
   412	                        <button onclick="exportOrderData()" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg text-sm">
   413	                            <i class="fas fa-download mr-1"></i>Export Data
   414	                        </button>
   415	                    </div>
   416	                </div>
   417	            </div>
   418	
   419	            <!-- Order Management Module (Hidden) -->
   420	            <div id="order-management" class="hidden"></div>
   421	
   422	            <!-- Advanced Features Grid -->
   423	            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
   424	                
   425	                <!-- Royal Mail Integration -->
   426	                <div class="glass-effect rounded-xl p-6">
   427	                    <div class="flex items-center mb-4">
   428	                        <i class="fas fa-shipping-fast text-xl text-red-600 mr-2"></i>
   429	                        <h3 class="text-lg font-semibold">Royal Mail Integration</h3>
   430	                    </div>
   431	                    <p class="text-sm text-gray-600 mb-4">Calculate shipping costs with 2025 pricing structure.</p>
   432	                    <button onclick="openShippingCalculator()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm">
   433	                        <i class="fas fa-calculator mr-1"></i>Shipping Calculator
   434	                    </button>
   435	                </div>
   436	
   437	                <!-- Wix Integration -->
   438	                <div class="glass-effect rounded-xl p-6">
   439	                    <div class="flex items-center mb-4">
   440	                        <i class="fas fa-store text-xl text-blue-600 mr-2"></i>
   441	                        <h3 class="text-lg font-semibold">Wix Store Sync</h3>
   442	                    </div>
   443	                    <p class="text-sm text-gray-600 mb-4">Import Star Seed's customer orders to streamline manufacturing invoicing.</p>
   444	                    <div class="space-y-2">
   445	                        <button onclick="syncWixData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
   446	                            <i class="fas fa-download mr-1"></i>Import Orders
   447	                        </button>
   448	                        <button onclick="showWixDataBrowser()" class="w-full bg-sage-600 hover:bg-sage-700 text-white py-2 px-4 rounded-lg text-sm">
   449	                            <i class="fas fa-list mr-1"></i>Review for Invoicing
   450	                        </button>
   451	                    </div>
   452	                </div>
   453	
   454	                <!-- Asana Integration -->
   455	                <div class="glass-effect rounded-xl p-6">
   456	                    <div class="flex items-center mb-4">
   457	                        <i class="fas fa-tasks text-xl text-purple-600 mr-2"></i>
   458	                        <h3 class="text-lg font-semibold">Asana Tasks</h3>
   459	                    </div>
   460	                    <p class="text-sm text-gray-600 mb-4">Import Ed's task assignments for offline orders and special requests.</p>
   461	                    <div class="space-y-2">
   462	                        <button onclick="syncAsanaData()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-sm">
   463	                            <i class="fas fa-download mr-1"></i>Import Tasks
   464	                        </button>
   465	                        <button onclick="showAsanaDataBrowser()" class="w-full bg-sage-600 hover:bg-sage-700 text-white py-2 px-4 rounded-lg text-sm">
   466	                            <i class="fas fa-clipboard-list mr-1"></i>Review Tasks
   467	                        </button>
   468	                    </div>
   469	                </div>
   470	
   471	                <!-- Auto-Invoicing -->
   472	                <div class="glass-effect rounded-xl p-6">
   473	                    <div class="flex items-center mb-4">
   474	                        <i class="fas fa-file-invoice-dollar text-xl text-green-600 mr-2"></i>
   475	                        <h3 class="text-lg font-semibold">Auto-Invoicing</h3>
   476	                    </div>
   477	                    <p class="text-sm text-gray-600 mb-4">Generate automated invoices with 50% deposit system.</p>
   478	                    <button onclick="generateInvoice()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm">
   479	                        <i class="fas fa-plus mr-1"></i>Create Invoice
   480	                    </button>
   481	                </div>
   482	
   483	                <!-- Royal Mail Shipping -->
   484	                <div class="glass-effect rounded-xl p-6">
   485	                    <div class="flex items-center mb-4">
   486	                        <i class="fas fa-shipping-fast text-xl text-red-600 mr-2"></i>
   487	                        <h3 class="text-lg font-semibold">Royal Mail Shipping</h3>
   488	                    </div>
   489	                    <p class="text-sm text-gray-600 mb-4">Generate shipping labels and auto-update Wix with tracking.</p>
   490	                    <div class="space-y-2">
   491	                        <button onclick="showShippingInterface()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm">
   492	                            <i class="fas fa-box mr-1"></i>Create Shipment
   493	                        </button>
   494	                        <button onclick="showShipmentBrowser()" class="w-full bg-sage-600 hover:bg-sage-700 text-white py-2 px-4 rounded-lg text-sm">
   495	                            <i class="fas fa-truck mr-1"></i>Track Shipments
   496	                        </button>
   497	                    </div>
   498	                </div>
   499	            </div>
   500	        </div>
   501	    </div>
   502	
   503	    <!-- JavaScript -->
   504	    <script>
   505	        let currentUser = null;
   506	        let productionChart = null;
   507	
   508	        // Initialize application
   509	        document.addEventListener('DOMContentLoaded', function() {
   510	            console.log('ðŸš€ Lush Labs Suite Manufacturing Operations - Initialized');
   511	            initializeProductionChart();
   512	        });
   513	
   514	        // Authentication Functions
   515	        function loginAs(type) {
   516	            const credentials = type === 'admin' ? 
   517	                { email: 'admin@luxebeauty.com', password: 'admin123' } :
   518	                { email: 'hello@starseednatural.com', password: 'starseed123' };
   519	
   520	            fetch('/auth/login', {
   521	                method: 'POST',
   522	                headers: { 'Content-Type': 'application/json' },
   523	                body: JSON.stringify(credentials)
   524	            })
   525	            .then(response => response.json())
   526	            .then(data => {
   527	                if (data.success) {
   528	                    currentUser = data.user;
   529	                    document.getElementById('loginSection').classList.add('hidden');
   530	                    document.getElementById('dashboardSection').classList.remove('hidden');
   531	                    document.getElementById('userInfo').classList.remove('hidden');
   532	                    document.getElementById('logoutBtn').classList.remove('hidden');
   533	                    document.getElementById('userName').textContent = data.user.name;
   534	                    
   535	                    showStatus(`âœ… Logged in as ${data.user.name}`, 'success');
   536	                    loadDashboardData();
   537	                } else {
   538	                    showStatus('Login failed', 'error');
   539	                }
   540	            })
   541	            .catch(error => {
   542	                console.error('Login error:', error);
   543	                showStatus('Login error: ' + error.message, 'error');
   544	            });
   545	        }
   546	
   547	        function logout() {
   548	            currentUser = null;
   549	            document.getElementById('loginSection').classList.remove('hidden');
   550	            document.getElementById('dashboardSection').classList.add('hidden');
   551	            document.getElementById('userInfo').classList.add('hidden');
   552	            document.getElementById('logoutBtn').classList.add('hidden');
   553	            showStatus('âœ… Logged out successfully', 'success');
   554	        }
   555	
   556	        // Dashboard Data Loading
   557	        async function loadDashboardData() {
   558	            try {
   559	                // Load counts for dashboard cards
   560	                loadCounts();
   561	                loadInventory();
   562	            } catch (error) {
   563	                console.error('Error loading dashboard data:', error);
   564	            }
   565	        }
   566	
   567	        async function loadCounts() {
   568	            try {
   569	                // Load formulation count
   570	                const formResponse = await fetch('/tables/product_formulations');
   571	                const formData = await formResponse.json();
   572	                document.getElementById('formulationCount').textContent = formData.data ? formData.data.length : '0';
   573	
   574	                // Load product count
   575	                const prodResponse = await fetch('/tables/products');
   576	                const prodData = await prodResponse.json();
   577	                document.getElementById('productCount').textContent = prodData.data ? prodData.data.length : '0';
   578	
   579	                // Load batch calculations count
   580	                const batchResponse = await fetch('/tables/batch_calculations');
   581	                const batchData = await batchResponse.json();
   582	                document.getElementById('batchCount').textContent = batchData.data ? batchData.data.length : '0';
   583	
   584	            } catch (error) {
   585	                document.getElementById('formulationCount').textContent = 'N/A';
   586	                document.getElementById('productCount').textContent = 'N/A';
   587	                document.getElementById('batchCount').textContent = 'N/A';
   588	            }
   589	        }
   590	
   591	        // Order Management Functions
   592	        async function loadOrderStats() {
   593	            try {
   594	                const response = await fetch('/tables/manufacturing_orders');
   595	                const result = await response.json();
   596	                const orders = result.data || [];
   597	
   598	                document.getElementById('totalOrdersCount').textContent = orders.length;
   599	                document.getElementById('pendingOrdersCount').textContent = orders.filter(o => o.status === 'Draft' || o.status === 'Deposit Required').length;
   600	                document.getElementById('completedOrdersCount').textContent = orders.filter(o => o.status === 'Completed').length;
   601	                
   602	                const totalRevenue = orders.reduce((sum, order) => sum + (order.total_manufacturing_cost || 0), 0);
   603	                document.getElementById('revenueTotal').textContent = `Â£${totalRevenue.toFixed(2)}`;
   604	
   605	                showStatus('âœ… Order statistics refreshed', 'success');
   606	            } catch (error) {
   607	                console.error('Error loading order stats:', error);
   608	                showStatus('Error loading orders: ' + error.message, 'error');
   609	            }
   610	        }
   611	
   612	        async function openOrderManagement() {
   613	            // Show the order management module
   614	            document.getElementById('order-management').classList.remove('hidden');
   615	            document.getElementById('dashboardSection').style.display = 'none';
   616	            
   617	            // Initialize order manager if not already done
   618	            if (!window.orderManager) {
   619	                window.orderManager = new OrderManager();
   620	            }
   621	            await window.orderManager.init();
   622	        }
   623	
   624	        // Complete Order Management System
   625	        class OrderManager {
   626	            constructor() {
   627	                this.orders = [];
   628	                this.clients = [];
   629	                this.products = [];
   630	            }
   631	
   632	            async init() {
   633	                await this.loadData();
   634	                this.renderInterface();
   635	            }
   636	
   637	            async loadData() {
   638	                try {
   639	                    // Load clients
   640	                    const clientsResponse = await fetch('/tables/clients');
   641	                    const clientsResult = await clientsResponse.json();
   642	                    this.clients = clientsResult.data || [];
   643	
   644	                    // Load products
   645	                    const productsResponse = await fetch('/tables/products');
   646	                    const productsResult = await productsResponse.json();
   647	                    this.products = productsResult.data || [];
   648	
   649	                    // Load existing orders
   650	                    const ordersResponse = await fetch('/tables/manufacturing_orders');
   651	                    const ordersResult = await ordersResponse.json();
   652	                    this.orders = ordersResult.data || [];
   653	
   654	                } catch (error) {
   655	                    console.error('Error loading order data:', error);
   656	                }
   657	            }
   658	
   659	            renderInterface() {
   660	                const content = `
   661	                <div class="p-6">
   662	                    <div class="flex justify-between items-center mb-6">
   663	                        <h2 class="text-2xl font-bold text-sage-800">Order Management</h2>
   664	                        <div class="flex gap-2">
   665	                            <button onclick="document.getElementById('dashboardSection').style.display='block'; document.getElementById('order-management').classList.add('hidden');" 
   666	                                    class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
   667	                                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
   668	                            </button>
   669	                            <button onclick="orderManager.showCreateOrderModal()" 
   670	                                    class="bg-sage-600 text-white px-4 py-2 rounded hover:bg-sage-700">
   671	                                <i class="fas fa-plus mr-2"></i>Create New Order
   672	                            </button>
   673	                        </div>
   674	                    </div>
   675	
   676	                    <!-- Quick Stats -->
   677	                    <div class="grid grid-cols-4 gap-4 mb-6">
   678	                        <div class="bg-white p-4 rounded-lg shadow">
   679	                            <h3 class="text-sm text-gray-600">Total Orders</h3>
   680	                            <p class="text-2xl font-bold text-sage-600">${this.orders.length}</p>
   681	                        </div>
   682	                        <div class="bg-white p-4 rounded-lg shadow">
   683	                            <h3 class="text-sm text-gray-600">In Production</h3>
   684	                            <p class="text-2xl font-bold text-blue-600">${this.orders.filter(o => o.status === 'In Production').length}</p>
   685	                        </div>
   686	                        <div class="bg-white p-4 rounded-lg shadow">
   687	                            <h3 class="text-sm text-gray-600">Pending Payment</h3>
   688	                            <p class="text-2xl font-bold text-orange-600">${this.orders.filter(o => o.status === 'Deposit Required').length}</p>
   689	                        </div>
   690	                        <div class="bg-white p-4 rounded-lg shadow">
   691	                            <h3 class="text-sm text-gray-600">Completed</h3>
   692	                            <p class="text-2xl font-bold text-green-600">${this.orders.filter(o => o.status === 'Completed').length}</p>
   693	                        </div>
   694	                    </div>
   695	
   696	                    <!-- Orders Table -->
   697	                    <div class="bg-white rounded-lg shadow overflow-hidden">
   698	                        <table class="w-full">
   699	                            <thead class="bg-sage-50">
   700	                                <tr>
   701	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Order #</th>
   702	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Client</th>
   703	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Product</th>
   704	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Quantity</th>
   705	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Total</th>
   706	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Status</th>
   707	                                    <th class="px-6 py-3 text-left text-xs font-medium text-sage-700 uppercase tracking-wider">Actions</th>
   708	                                </tr>
   709	                            </thead>
   710	                            <tbody class="divide-y divide-gray-200">
   711	                                ${this.renderOrderRows()}
   712	                            </tbody>
   713	                        </table>
   714	                    </div>
   715	                </div>
   716	
   717	                <!-- Create Order Modal -->
   718	                <div id="createOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
   719	                    <div class="flex items-center justify-center min-h-screen p-4">
   720	                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
   721	                            <div class="p-6">
   722	                                <div class="flex justify-between items-center mb-4">
   723	                                    <h3 class="text-lg font-bold">Create New Order</h3>
   724	                                    <button onclick="orderManager.closeCreateOrderModal()" class="text-gray-400 hover:text-gray-600">
   725	                                        <i class="fas fa-times"></i>
   726	                                    </button>
   727	                                </div>
   728	                                
   729	                                <form id="createOrderForm" onsubmit="orderManager.createOrder(event)">
   730	                                    <div class="grid grid-cols-2 gap-4 mb-4">
   731	                                        <div>
   732	                                            <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
   733	                                            <select id="orderClient" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
   734	                                                <option value="">Select Client</option>
   735	                                                ${this.clients.map(client => 
   736	                                                    `<option value="${client.id}">${client.company_name}</option>`
   737	                                                ).join('')}
   738	                                            </select>
   739	                                        </div>
   740	                                        <div>
   741	                                            <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
   742	                                            <select id="orderProduct" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
   743	                                                <option value="">Select Product</option>
   744	                                                ${this.products.map(product => 
   745	                                                    `<option value="${product.id}" data-name="${product.name}">${product.name} (${product.sku})</option>`
   746	                                                ).join('')}
   747	                                            </select>
   748	                                        </div>
   749	                                    </div>
   750	
   751	                                    <div class="grid grid-cols-2 gap-4 mb-4">
   752	                                        <div>
   753	                                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
   754	                                            <input type="number" id="orderQuantity" required min="1" 
   755	                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
   756	                                                   onchange="orderManager.calculateOrderTotal()">
   757	                                        </div>
   758	                                        <div>
   759	                                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price (Â£)</label>
   760	                                            <input type="number" id="orderUnitPrice" required step="0.01" min="0"
   761	                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
   762	                                                   onchange="orderManager.calculateOrderTotal()">
   763	                                        </div>
   764	                                    </div>
   765	
   766	                                    <div class="grid grid-cols-2 gap-4 mb-4">
   767	                                        <div>
   768	                                            <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Date</label>
   769	                                            <input type="date" id="orderDeliveryDate" required 
   770	                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2">
   771	                                        </div>
   772	                                        <div>
   773	                                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Cost</label>
   774	                                            <input type="text" id="orderTotal" readonly 
   775	                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50"
   776	                                                   value="Â£0.00">
   777	                                        </div>
   778	                                    </div>
   779	
   780	                                    <div class="mb-4">
   781	                                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
   782	                                        <textarea id="orderNotes" rows="3" 
   783	                                                  class="w-full border border-gray-300 rounded-lg px-3 py-2"
   784	                                                  placeholder="Order notes or special requirements..."></textarea>
   785	                                    </div>
   786	
   787	                                    <div class="flex justify-end gap-2">
   788	                                        <button type="button" onclick="orderManager.closeCreateOrderModal()" 
   789	                                                class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
   790	                                            Cancel
   791	                                        </button>
   792	                                        <button type="submit" 
   793	                                                class="px-4 py-2 bg-sage-600 text-white rounded-lg hover:bg-sage-700">
   794	                                            Create Order & Generate Invoice
   795	                                        </button>
   796	                                    </div>
   797	                                </form>
   798	                            </div>
   799	                        </div>
   800	                    </div>
   801	                </div>`;
   802	
   803	                document.getElementById('order-management').innerHTML = content;
   804	            }
   805	
   806	            renderOrderRows() {
   807	                if (this.orders.length === 0) {
   808	                    return `
   809	                        <tr>
   810	                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
   811	                                No orders found. Click "Create New Order" to get started.
   812	                            </td>
   813	                        </tr>
   814	                    `;
   815	                }
   816	
   817	                return this.orders.map(order => {
   818	                    const client = this.clients.find(c => c.id === order.client_id);
   819	                    const statusColors = {
   820	                        'Draft': 'bg-gray-100 text-gray-800',
   821	                        'Deposit Required': 'bg-yellow-100 text-yellow-800',
   822	                        'In Production': 'bg-blue-100 text-blue-800',
   823	                        'Completed': 'bg-green-100 text-green-800',
   824	                        'Cancelled': 'bg-red-100 text-red-800'
   825	                    };
   826	
   827	                    return `
   828	                        <tr>
   829	                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
   830	                                ${order.order_number}
   831	                            </td>
   832	                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
   833	                                ${client ? client.company_name : 'Unknown'}
   834	                            </td>
   835	                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
   836	                                ${order.product_id}
   837	                            </td>
   838	                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
   839	                                ${order.quantity_requested}
   840	                            </td>
   841	                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
   842	                                Â£${order.total_manufacturing_cost ? order.total_manufacturing_cost.toFixed(2) : '0.00'}
   843	                            </td>
   844	                            <td class="px-6 py-4 whitespace-nowrap">
   845	                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[order.status] || 'bg-gray-100 text-gray-800'}">
   846	                                    ${order.status}
   847	                                </span>
   848	                            </td>
   849	                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
   850	                                <button onclick="orderManager.viewOrder('${order.id}')" 
   851	                                        class="text-sage-600 hover:text-sage-900 mr-2">
   852	                                    <i class="fas fa-eye"></i>
   853	                                </button>
   854	                                <button onclick="orderManager.generateInvoice('${order.id}')" 
   855	                                        class="text-blue-600 hover:text-blue-900 mr-2">
   856	                                    <i class="fas fa-file-invoice"></i>
   857	                                </button>
   858	                                <button onclick="orderManager.sendEmail('${order.id}')" 
   859	                                        class="text-green-600 hover:text-green-900">
   860	                                    <i class="fas fa-envelope"></i>
   861	                                </button>
   862	                            </td>
   863	                        </tr>
   864	                    `;
   865	                }).join('');
   866	            }
   867	
   868	            showCreateOrderModal() {
   869	                document.getElementById('createOrderModal').classList.remove('hidden');
   870	                // Set default delivery date to 30 days from now
   871	                const deliveryDate = new Date();
   872	                deliveryDate.setDate(deliveryDate.getDate() + 30);
   873	                document.getElementById('orderDeliveryDate').value = deliveryDate.toISOString().split('T')[0];
   874	            }
   875	
   876	            closeCreateOrderModal() {
   877	                document.getElementById('createOrderModal').classList.add('hidden');
   878	                document.getElementById('createOrderForm').reset();
   879	            }
   880	
   881	            calculateOrderTotal() {
   882	                const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
   883	                const unitPrice = parseFloat(document.getElementById('orderUnitPrice').value) || 0;
   884	                const total = quantity * unitPrice;
   885	                document.getElementById('orderTotal').value = `Â£${total.toFixed(2)}`;
   886	            }
   887	
   888	            async createOrder(event) {
   889	                event.preventDefault();
   890	                
   891	                try {
   892	                    const formData = {
   893	                        client_id: document.getElementById('orderClient').value,
   894	                        product_id: document.getElementById('orderProduct').value,
   895	                        quantity_requested: parseInt(document.getElementById('orderQuantity').value),
   896	                        manufacturing_cost_per_unit: parseFloat(document.getElementById('orderUnitPrice').value),
   897	                        total_manufacturing_cost: parseFloat(document.getElementById('orderQuantity').value) * parseFloat(document.getElementById('orderUnitPrice').value),
   898	                        requested_delivery_date: document.getElementById('orderDeliveryDate').value,
   899	                        notes: document.getElementById('orderNotes').value,
   900	                        status: 'Draft',
   901	                        order_number: this.generateOrderNumber(),
   902	                        deposit_amount: (parseFloat(document.getElementById('orderQuantity').value) * parseFloat(document.getElementById('orderUnitPrice').value)) * 0.5,
   903	                        remaining_amount: (parseFloat(document.getElementById('orderQuantity').value) * parseFloat(document.getElementById('orderUnitPrice').value)) * 0.5,
   904	                        deposit_paid: false,
   905	                        samples_approved: false,
   906	                        final_payment_due: false,
   907	                        final_payment_paid: false,
   908	                        batch_size: 1,
   909	                        tenant_id: 'luxebeauty_001'
   910	                    };
   911	
   912	                    // Create the order
   913	                    const response = await fetch('/tables/manufacturing_orders', {
   914	                        method: 'POST',
   915	                        headers: { 'Content-Type': 'application/json' },
   916	                        body: JSON.stringify(formData)
   917	                    });
   918	
   919	                    if (response.ok) {
   920	                        const result = await response.json();
   921	                        
   922	                        // Automatically generate and send invoice
   923	                        await this.generateAndSendInvoice(result.id, formData);
   924	                        
   925	                        // Refresh the orders list
   926	                        await this.loadData();
   927	                        this.renderInterface();
   928	                        this.closeCreateOrderModal();
   929	                        
   930	                        showStatus(`âœ… Order ${formData.order_number} created successfully and invoice sent!`, 'success');
   931	                    } else {
   932	                        throw new Error('Failed to create order');
   933	                    }
   934	
   935	                } catch (error) {
   936	                    console.error('Error creating order:', error);
   937	                    showStatus('âŒ Error creating order: ' + error.message, 'error');
   938	                }
   939	            }
   940	
   941	            generateOrderNumber() {
   942	                const date = new Date();
   943	                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
   944	                const timeStr = date.toTimeString().slice(0, 8).replace(/:/g, '');
   945	                return `ORD-${dateStr}-${timeStr}`;
   946	            }
   947	
   948	            async generateAndSendInvoice(orderId, orderData) {
   949	                try {
   950	                    // Generate invoice data
   951	                    const invoiceData = {
   952	                        clientId: orderData.client_id,
   953	                        orderData: {
   954	                            orderNumber: orderData.order_number,
   955	                            notes: orderData.notes
   956	                        },
   957	                        items: [{
   958	                            name: orderData.product_id,
   959	                            description: `Manufacturing order for ${orderData.product_id}`,
   960	                            quantity: orderData.quantity_requested,
   961	                            price: orderData.manufacturing_cost_per_unit
   962	                        }],
   963	                        sendEmail: true
   964	                    };
   965	
   966	                    // Call email invoice function
   967	                    const response = await fetch('/.netlify/functions/email-invoice', {
   968	                        method: 'POST',
   969	                        headers: { 'Content-Type': 'application/json' },
   970	                        body: JSON.stringify({
   971	                            action: 'create_and_send',
   972	                            ...invoiceData
   973	                        })
   974	                    });
   975	
   976	                    if (response.ok) {
   977	                        const result = await response.json();
   978	                        console.log('Invoice sent:', result);
   979	                        return result;
   980	                    } else {
   981	                        throw new Error('Failed to send invoice');
   982	                    }
   983	
   984	                } catch (error) {
   985	                    console.error('Error generating invoice:', error);
   986	                    // Don't fail the order creation if invoice fails
   987	                    return null;
   988	                }
   989	            }
   990	
   991	            async generateInvoice(orderId) {
   992	                try {
   993	                    const order = this.orders.find(o => o.id === orderId);
   994	                    if (!order) return;
   995	
   996	                    await this.generateAndSendInvoice(orderId, order);
   997	                    showStatus('âœ… Invoice generated and sent successfully!', 'success');
   998	
   999	                } catch (error) {
  1000	                    console.error('Error generating invoice:', error);
  1001	                    showStatus('âŒ Error generating invoice: ' + error.message, 'error');
  1002	                }
  1003	            }
  1004	
  1005	            async sendEmail(orderId) {
  1006	                try {
  1007	                    // Implementation for sending custom emails
  1008	                    showStatus('ðŸ“§ Email functionality - ready to be customized', 'info');
  1009	                } catch (error) {
  1010	                    console.error('Error sending email:', error);
  1011	                }
  1012	            }
  1013	
  1014	            viewOrder(orderId) {
  1015	                const order = this.orders.find(o => o.id === orderId);
  1016	                if (order) {
  1017	                    // Show order details modal
  1018	                    alert(`Order Details:\n${JSON.stringify(order, null, 2)}`);
  1019	                }
  1020	            }
  1021	        }
  1022	
  1023	        async function generateBulkInvoices() {
  1024	            try {
  1025	                showStatus('ðŸ”„ Generating bulk invoices...', 'info');
  1026	                
  1027	                const response = await fetch('/tables/wix_orders?status=Imported');
  1028	                const result = await response.json();
  1029	                const orders = result.data || [];
  1030	
  1031	                if (orders.length === 0) {
  1032	                    showStatus('No imported orders found for invoicing', 'info');
  1033	                    return;
  1034	                }
  1035	
  1036	                let invoicesCreated = 0;
  1037	                for (const order of orders) {
  1038	                    try {
  1039	                        const invoiceResponse = await fetch('/.netlify/functions/email-invoice', {
  1040	                            method: 'POST',
  1041	                            headers: { 'Content-Type': 'application/json' },
  1042	                            body: JSON.stringify({
  1043	                                action: 'create_and_send',
  1044	                                clientId: order.client_id,
  1045	                                orderData: {
  1046	                                    orderNumber: order.order_number,
  1047	                                    notes: `Generated from Wix order ${order.wix_order_id}`
  1048	                                },
  1049	                                items: [{
  1050	                                    name: 'Manufacturing Services',
  1051	                                    description: `Manufacturing for order ${order.order_number}`,
  1052	                                    quantity: 1,
  1053	                                    price: order.order_total
  1054	                                }],
  1055	                                sendEmail: true
  1056	                            })
  1057	                        });
  1058	
  1059	                        if (invoiceResponse.ok) {
  1060	                            invoicesCreated++;
  1061	                        }
  1062	                    } catch (error) {
  1063	                        console.error('Error creating invoice for order:', order.id, error);
  1064	                    }
  1065	                }
  1066	
  1067	                showStatus(`âœ… Generated ${invoicesCreated} invoices from ${orders.length} orders`, 'success');
  1068	                loadOrderStats();
  1069	
  1070	            } catch (error) {
  1071	                console.error('Error generating bulk invoices:', error);
  1072	                showStatus('Error generating invoices: ' + error.message, 'error');
  1073	            }
  1074	        }
  1075	
  1076	        async function exportOrderData() {
  1077	            try {
  1078	                const response = await fetch('/tables/manufacturing_orders');
  1079	                const result = await response.json();
  1080	                const orders = result.data || [];
  1081	
  1082	                if (orders.length === 0) {
  1083	                    showStatus('No orders to export', 'info');
  1084	                    return;
  1085	                }
  1086	
  1087	                // Convert to CSV
  1088	                const headers = ['Order Number', 'Client', 'Product', 'Quantity', 'Total Cost', 'Status', 'Delivery Date'];
  1089	                let csvContent = headers.join(',') + '\n';
  1090	
  1091	                orders.forEach(order => {
  1092	                    const row = [
  1093	                        order.order_number || '',
  1094	                        order.client_id || '',
  1095	                        order.product_id || '',
  1096	                        order.quantity_requested || 0,
  1097	                        order.total_manufacturing_cost || 0,
  1098	                        order.status || '',
  1099	                        order.requested_delivery_date || ''
  1100	                    ];
  1101	                    csvContent += row.join(',') + '\n';
  1102	                });
  1103	
  1104	                // Download CSV
  1105	                const blob = new Blob([csvContent], { type: 'text/csv' });
  1106	                const url = window.URL.createObjectURL(blob);
  1107	                const a = document.createElement('a');
  1108	                a.href = url;
  1109	                a.download = `manufacturing-orders-${new Date().toISOString().split('T')[0]}.csv`;
  1110	                document.body.appendChild(a);
  1111	                a.click();
  1112	                document.body.removeChild(a);
  1113	                window.URL.revokeObjectURL(url);
  1114	
  1115	                showStatus(`âœ… Exported ${orders.length} orders to CSV`, 'success');
  1116	
  1117	            } catch (error) {
  1118	                console.error('Error exporting order data:', error);
  1119	                showStatus('Error exporting data: ' + error.message, 'error');
  1120	            }
  1121	        }
  1122	
  1123	        function openWixIntegration() {
  1124	            openWixBrowser();
  1125	        }
  1126	
  1127	        // Initialize order stats when dashboard loads
  1128	        document.addEventListener('DOMContentLoaded', function() {
  1129	            setTimeout(loadOrderStats, 2000);
  1130	        });
  1131	
  1132	        // Formulation Calculator
  1133	        async function calculateBatch() {
  1134	            const productId = document.getElementById('productSelect').value;
  1135	            const batchSize = parseFloat(document.getElementById('batchSize').value);
  1136	
  1137	            if (!productId || !batchSize) {
  1138	                showStatus('Please select a product and enter batch size', 'error');
  1139	                return;
  1140	            }
  1141	
  1142	            try {
  1143	                showStatus('ðŸ”„ Calculating batch ingredients...', 'info');
  1144	                
  1145	                const batchNumber = generateBatchNumber(productId);
  1146	                
  1147	                // Mock calculation for demo (replace with real formulation data)
  1148	                const mockIngredients = [
  1149	                    { name: 'Aqua (Water)', percentage: 65.5, costPerKg: 0.01, phase: 'A' },
  1150	                    { name: 'Glycerin', percentage: 5.0, costPerKg: 2.50, phase: 'A' },
  1151	                    { name: 'Cetearyl Alcohol', percentage: 4.0, costPerKg: 3.80, phase: 'B' },
  1152	                    { name: 'Caprylic/Capric Triglyceride', percentage: 8.0, costPerKg: 4.20, phase: 'B' },
  1153	                    { name: 'Shea Butter', percentage: 3.0, costPerKg: 8.50, phase: 'B' },
  1154	                    { name: 'Natural Extract Blend', percentage: 2.0, costPerKg: 25.00, phase: 'C' },
  1155	                    { name: 'Tocopherol (Vitamin E)', percentage: 0.5, costPerKg: 35.00, phase: 'C' },
  1156	                    { name: 'Preservative System', percentage: 1.0, costPerKg: 12.00, phase: 'Final' },
  1157	                    { name: 'Natural Fragrance', percentage: 1.0, costPerKg: 18.00, phase: 'Final' }
  1158	                ];
  1159	                
  1160	                let totalCost = 0;
  1161	                let calculationHTML = `
  1162	                    <div class="mb-4 p-4 bg-white rounded-lg border">
  1163	                        <div class="grid grid-cols-2 gap-4 mb-4">
  1164	                            <div><strong>ðŸ”¢ Batch Number:</strong> <span class="font-mono text-lg">${batchNumber}</span></div>
  1165	                            <div><strong>ðŸ“ Batch Size:</strong> ${batchSize} kg</div>
  1166	                            <div><strong>ðŸ“… Date:</strong> ${new Date().toLocaleDateString()}</div>
  1167	                            <div><strong>ðŸ‘¤ Operator:</strong> ${currentUser.name}</div>
  1168	                        </div>
  1169	                    </div>
  1170	                    
  1171	                    <div class="space-y-2">
  1172	                        <h5 class="font-semibold text-gray-800 border-b pb-2">ðŸ“‹ Manufacturing Instructions:</h5>
  1173	                `;
  1174	                
  1175	                const phases = ['A', 'B', 'C', 'Final'];
  1176	                phases.forEach(phase => {
  1177	                    const phaseIngredients = mockIngredients.filter(ing => ing.phase === phase);
  1178	                    if (phaseIngredients.length > 0) {
  1179	                        calculationHTML += `<div class="mt-3"><strong>Phase ${phase}:</strong></div>`;
  1180	                        phaseIngredients.forEach(ing => {
  1181	                            const quantity = (batchSize * ing.percentage / 100);
  1182	                            const cost = quantity * ing.costPerKg;
  1183	                            totalCost += cost;
  1184	                            calculationHTML += `<div class="text-sm pl-4">â€¢ <strong>${ing.name}:</strong> ${quantity.toFixed(3)} kg (${ing.percentage}%) - Â£${cost.toFixed(2)}</div>`;
  1185	                        });
  1186	                    }
  1187	                });
  1188	                
  1189	                calculationHTML += `
  1190	                    </div>
  1191	                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
  1192	                        <div class="grid grid-cols-2 gap-4 text-sm">
  1193	                            <div><strong>ðŸ’° Total Raw Materials:</strong> Â£${totalCost.toFixed(2)}</div>
  1194	                            <div><strong>ðŸ“Š Cost per kg:</strong> Â£${(totalCost/batchSize).toFixed(2)}</div>
  1195	                        </div>
  1196	                    </div>
  1197	                `;
  1198	
  1199	                document.getElementById('calculationDetails').innerHTML = calculationHTML;
  1200	                document.getElementById('calculationResults').classList.remove('hidden');
  1201	
  1202	                // Save calculation to database
  1203	                const calculationData = {
  1204	                    formulation_id: productId,
  1205	                    batch_number: batchNumber,
  1206	                    requested_batch_size_kg: batchSize,
  1207	                    scale_factor: 1.0,
  1208	                    calculated_ingredients: JSON.stringify(mockIngredients),
  1209	                    total_cost: totalCost,
  1210	                    cost_per_kg: totalCost/batchSize,
  1211	                    status: 'Calculated',
  1212	                    created_by: currentUser.email,
  1213	                    tenant_id: 'luxebeauty_001'
  1214	                };
  1215	
  1216	                try {
  1217	                    await fetch('/tables/batch_calculations', {
  1218	                        method: 'POST',
  1219	                        headers: { 'Content-Type': 'application/json' },
  1220	                        body: JSON.stringify(calculationData)
  1221	                    });
  1222	                    showStatus('âœ… Batch calculation saved to database', 'success');
  1223	                    loadCounts(); // Refresh counts
  1224	                } catch (saveError) {
  1225	                    console.warn('Could not save to database:', saveError.message);
  1226	                }
  1227	
  1228	            } catch (error) {
  1229	                showStatus('Calculation error: ' + error.message, 'error');
  1230	            }
  1231	        }
  1232	
  1233	        // Inventory Management
  1234	        async function loadInventory() {
  1235	            try {
  1236	                showStatus('ðŸ”„ Loading inventory from Neon database...', 'info');
  1237	                const response = await fetch('/tables/products');
  1238	                const data = await response.json();
  1239	                const products = data.data || [];
  1240	                
  1241	                if (products.length === 0) {
  1242	                    document.getElementById('inventoryList').innerHTML = `
  1243	                        <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
  1244	                            <p class="text-yellow-800">âš ï¸ No products found</p>
  1245	                            <p class="text-xs text-yellow-600">Ensure database setup is complete</p>
  1246	                        </div>
  1247	                    `;
  1248	                    return;
  1249	                }
  1250	                
  1251	                let html = '';
  1252	                products.forEach(product => {
  1253	                    const stockLevel = product.current_stock || 0;
  1254	                    const minStock = product.minimum_stock || 10;
  1255	                    
  1256	                    let statusClass, statusIcon, statusText;
  1257	                    if (stockLevel > minStock * 1.5) {
  1258	                        statusClass = 'bg-green-50 border-green-200 text-green-800';
  1259	                        statusIcon = 'âœ…';
  1260	                        statusText = 'Good Stock';
  1261	                    } else if (stockLevel > minStock) {
  1262	                        statusClass = 'bg-yellow-50 border-yellow-200 text-yellow-800';
  1263	                        statusIcon = 'âš ï¸';
  1264	                        statusText = 'Low Stock';
  1265	                    } else {
  1266	                        statusClass = 'bg-red-50 border-red-200 text-red-800';
  1267	                        statusIcon = 'ðŸ”´';
  1268	                        statusText = 'Critical';
  1269	                    }
  1270	                    
  1271	                    html += `
  1272	                        <div class="flex justify-between items-center p-3 ${statusClass} rounded-lg border">
  1273	                            <div>
  1274	                                <div class="font-medium">${statusIcon} ${product.name}</div>
  1275	                                <div class="text-xs opacity-75">${product.sku} â€¢ Min: ${minStock}</div>
  1276	                            </div>
  1277	                            <div class="text-right">
  1278	                                <div class="text-lg font-bold">${stockLevel}</div>
  1279	                                <div class="text-xs">${statusText}</div>
  1280	                            </div>
  1281	                        </div>
  1282	                    `;
  1283	                });
  1284	                
  1285	                document.getElementById('inventoryList').innerHTML = html;
  1286	                showStatus(`âœ… Loaded ${products.length} products from database`, 'success');
  1287	                
  1288	            } catch (error) {
  1289	                showStatus('Error loading inventory: ' + error.message, 'error');
  1290	                document.getElementById('inventoryList').innerHTML = `
  1291	                    <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
  1292	                        <p class="text-red-800">âŒ Connection Error</p>
  1293	                        <p class="text-xs text-red-600">${error.message}</p>
  1294	                    </div>
  1295	                `;
  1296	            }
  1297	        }
  1298	
  1299	        // Database Management Functions
  1300	        async function testConnection() {
  1301	            try {
  1302	                showDbResult('ðŸ”„ Testing Neon database connection...');
  1303	                
  1304	                // Try the Netlify function first
  1305	                const response = await fetch('/.netlify/functions/db-query/products');
  1306	                
  1307	                if (response.ok) {
  1308	                    const data = await response.json();
  1309	                    if (data && data.data) {
  1310	                        showDbResult(`âœ… Neon Database connected successfully! Found ${data.data.length} Star Seed products.`);
  1311	                    } else {
  1312	                        showDbResult(`âœ… Connected to Neon, but no data found. Response: ${JSON.stringify(data)}`);
  1313	                    }
  1314	                } else {
  1315	                    // If Netlify function fails, show helpful error
  1316	                    const errorText = await response.text();
  1317	                    if (errorText.includes('<')) {
  1318	                        showDbResult(`âš ï¸ Netlify Function not deployed yet.\n\nTo fix:\n1. Add netlify.toml to GitHub\n2. Add package.json with pg dependency\n3. Add netlify/functions/db-query.js\n4. Push to GitHub`);
  1319	                    } else {
  1320	                        showDbResult(`âŒ Database error: ${errorText}`);
  1321	                    }
  1322	                }
  1323	            } catch (error) {
  1324	                showDbResult(`âŒ Connection failed: ${error.message}\n\nLikely cause: Netlify Functions not deployed yet.`);
  1325	            }
  1326	        }
  1327	
  1328	        async function loadProducts() {
  1329	            try {
  1330	                showDbResult('ðŸ”„ Loading products...');
  1331	                const response = await fetch('/tables/products');
  1332	                const data = await response.json();
  1333	                const products = data.data || [];
  1334	                let result = `âœ… Products (${products.length}):\n`;
  1335	                products.forEach(p => {
  1336	                    result += `â€¢ ${p.name} (${p.sku}) - Stock: ${p.current_stock}\n`;
  1337	                });
  1338	                showDbResult(result);
  1339	            } catch (error) {
  1340	                showDbResult(`âŒ Error: ${error.message}`);
  1341	            }
  1342	        }
  1343	
  1344	        async function loadFormulations() {
  1345	            try {
  1346	                showDbResult('ðŸ”„ Loading formulations...');
  1347	                const response = await fetch('/tables/product_formulations');
  1348	                const data = await response.json();
  1349	                const formulations = data.data || [];
  1350	                let result = `âœ… Formulations (${formulations.length}):\n`;
  1351	                formulations.forEach(f => {
  1352	                    result += `â€¢ ${f.formulation_name} (${f.batch_size_kg}kg)\n`;
  1353	                });
  1354	                showDbResult(result);
  1355	            } catch (error) {
  1356	                showDbResult(`âŒ Error: ${error.message}`);
  1357	            }
  1358	        }
  1359	
  1360	        async function createTestBatch() {
  1361	            try {
  1362	                showDbResult('ðŸ”„ Creating test batch...');
  1363	                const batchData = {
  1364	                    formulation_id: 'test-' + Date.now(),
  1365	                    batch_number: generateBatchNumber('TEST'),
  1366	                    requested_batch_size_kg: 5.0,
  1367	                    scale_factor: 1.0,
  1368	                    calculated_ingredients: JSON.stringify([{name: 'Test Ingredient', quantity: 1.0}]),
  1369	                    total_cost: 25.50,
  1370	                    status: 'Test',
  1371	                    created_by: currentUser?.email || 'system',
  1372	                    tenant_id: 'luxebeauty_001'
  1373	                };
  1374	
  1375	                const response = await fetch('/tables/batch_calculations', {
  1376	                    method: 'POST',
  1377	                    headers: { 'Content-Type': 'application/json' },
  1378	                    body: JSON.stringify(batchData)
  1379	                });
  1380	
  1381	                const result = await response.json();
  1382	                showDbResult(`âœ… Test batch created: ${result.batch_number || 'Success'}`);
  1383	                loadCounts();
  1384	            } catch (error) {
  1385	                showDbResult(`âŒ Error: ${error.message}`);
  1386	            }
  1387	        }
  1388	
  1389	        // Utility Functions
  1390	        function generateBatchNumber(productId = 'TEST') {
  1391	            const productLetter = productId.includes('FC') ? 'F' : 
  1392	                                 productId.includes('MC') ? 'M' : 
  1393	                                 productId.includes('SS') ? 'S' : 
  1394	                                 productId.includes('DK') ? 'D' : 'T';
  1395	            const now = new Date();
  1396	            const day = String(now.getDate()).padStart(2, '0');
  1397	            const month = String(now.getMonth() + 1).padStart(2, '0');
  1398	            const year = String(now.getFullYear()).slice(-2);
  1399	            return `${productLetter}${day}${month}${year}`;
  1400	        }
  1401	
  1402	        function initializeProductionChart() {
  1403	            const ctx = document.getElementById('productionChart').getContext('2d');
  1404	            productionChart = new Chart(ctx, {
  1405	                type: 'line',
  1406	                data: {
  1407	                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
  1408	                    datasets: [{
  1409	                        label: 'Production Volume',
  1410	                        data: [120, 180, 150, 220, 200, 247],
  1411	                        borderColor: '#3B82F6',
  1412	                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
  1413	                        tension: 0.4
  1414	                    }]
  1415	                },
  1416	                options: {
  1417	                    responsive: true,
  1418	                    maintainAspectRatio: false,
  1419	                    scales: {
  1420	                        y: {
  1421	                            beginAtZero: true
  1422	                        }
  1423	                    }
  1424	                }
  1425	            });
  1426	        }
  1427	
  1428	        // Advanced Feature Placeholders
  1429	        function openShippingCalculator() {
  1430	            showStatus('ðŸš¢ Royal Mail shipping calculator - Coming soon!', 'info');
  1431	        }
  1432	
  1433	        function syncWixData() {
  1434	            showWixSyncInterface();
  1435	        }
  1436	
  1437	        function showWixSyncInterface() {
  1438	            const wixModalHtml = `
  1439	                <div id="wixSyncModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
  1440	                    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4 border border-sage-200">
  1441	                        <div class="flex items-center justify-between mb-6">
  1442	                            <div class="flex items-center">
  1443	                                <i class="fas fa-store text-blue-600 text-2xl mr-3"></i>
  1444	                                <h2 class="text-2xl font-bold text-gray-900">Wix Store Integration</h2>
  1445	                            </div>
  1446	                            <button onclick="closeWixModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
  1447	                                <i class="fas fa-times text-xl"></i>
  1448	                            </button>
  1449	                        </div>
  1450	
  1451	                        <!-- Connection Status -->
  1452	                        <div id="wixConnectionStatus" class="mb-6 p-4 rounded-lg border">
  1453	                            <div class="flex items-center">
  1454	                                <div class="animate-pulse w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
  1455	                                <span class="font-medium text-gray-900">Connection Status: Not Connected</span>
  1456	                            </div>
  1457	                            <p class="text-sm text-gray-600 mt-1">Enter your Wix API credentials to connect</p>
  1458	                        </div>
  1459	
  1460	                        <!-- API Configuration -->
  1461	                        <div class="space-y-4 mb-6">
  1462	                            <div>
  1463	                                <label for="wixAppId" class="block text-sm font-medium text-gray-700 mb-2">
  1464	                                    App ID <span class="text-red-500">*</span>
  1465	                                </label>
  1466	                                <input type="text" id="wixAppId" 
  1467	                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 focus:border-sage-500"
  1468	                                       placeholder="c47246a0-9439-41f4-a28e-75c5f745938a"
  1469	                                       value="c47246a0-9439-41f4-a28e-75c5f745938a">
  1470	                                <p class="text-xs text-gray-500 mt-1">Your Wix App ID from Developer Console</p>
  1471	                            </div>
  1472	
  1473	                            <div>
  1474	                                <label for="wixSecretKey" class="block text-sm font-medium text-gray-700 mb-2">
  1475	                                    Secret Key <span class="text-red-500">*</span>
  1476	                                </label>
  1477	                                <input type="password" id="wixSecretKey" 
  1478	                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 focus:border-sage-500"
  1479	                                       placeholder="6ea6c354-3f7f-4d38-84d1-10de751b79a7"
  1480	                                       value="6ea6c354-3f7f-4d38-84d1-10de751b79a7">
  1481	                                <p class="text-xs text-gray-500 mt-1">Your Wix Secret Key for authentication</p>
  1482	                            </div>
  1483	
  1484	                            <div>
  1485	                                <label for="wixClientId" class="block text-sm font-medium text-gray-700 mb-2">
  1486	                                    Client ID <span class="text-red-500">*</span>
  1487	                                </label>
  1488	                                <input type="text" id="wixClientId" 
  1489	                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 focus:border-sage-500"
  1490	                                       placeholder="99f9c2ea-9cd3-4c66-b965-e2db260f3aba"
  1491	                                       value="99f9c2ea-9cd3-4c66-b965-e2db260f3aba">
  1492	                                <p class="text-xs text-gray-500 mt-1">Your Wix Client ID for API access</p>
  1493	                            </div>
  1494	
  1495	                            <div id="storeIdDisplay" class="hidden">
  1496	                                <label class="block text-sm font-medium text-gray-700 mb-2">Store ID (Retrieved Automatically)</label>
  1497	                                <div id="retrievedStoreId" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-mono text-sm"></div>
  1498	                            </div>
  1499	                        </div>
  1500	
  1501	                        <!-- Sync Options -->
  1502	                        <div class="mb-6">
  1503	                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Import Options</h3>
  1504	                            <div class="grid grid-cols-2 gap-4">
  1505	                                <div class="space-y-3">
  1506	                                    <label class="flex items-center">
  1507	                                        <input type="checkbox" id="syncCustomers" checked 
  1508	                                               class="rounded border-gray-300 text-sage-600 focus:ring-sage-500">
  1509	                                        <span class="ml-3 text-sm text-gray-900">Import Customer Data</span>
  1510	                                    </label>
  1511	                                    <label class="flex items-center">
  1512	                                        <input type="checkbox" id="syncOrders" checked 
  1513	                                               class="rounded border-gray-300 text-sage-600 focus:ring-sage-500">
  1514	                                        <span class="ml-3 text-sm text-gray-900">Import Orders for Invoicing</span>
  1515	                                    </label>
  1516	                                </div>
  1517	                                <div class="space-y-3">
  1518	                                    <div>
  1519	                                        <label for="dateFrom" class="block text-xs text-gray-600 mb-1">Invoice Period From</label>
  1520	                                        <input type="date" id="dateFrom" 
  1521	                                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-sage-500">
  1522	                                    </div>
  1523	                                    <div>
  1524	                                        <label for="dateTo" class="block text-xs text-gray-600 mb-1">Invoice Period To</label>
  1525	                                        <input type="date" id="dateTo" 
  1526	                                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-sage-500">
  1527	                                    </div>
  1528	                                </div>
  1529	                            </div>
  1530	                        </div>
  1531	
  1532	                        <!-- Progress Bar -->
  1533	                        <div id="wixSyncProgress" class="hidden mb-6">
  1534	                            <div class="flex justify-between text-sm text-gray-600 mb-2">
  1535	                                <span id="progressText">Initializing sync...</span>
  1536	                                <span id="progressPercent">0%</span>
  1537	                            </div>
  1538	                            <div class="w-full bg-gray-200 rounded-full h-2">
  1539	                                <div id="progressBar" class="bg-sage-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
  1540	                            </div>
  1541	                        </div>
  1542	
  1543	                        <!-- Sync Results -->
  1544	                        <div id="wixSyncResults" class="hidden mb-6"></div>
  1545	
  1546	                        <!-- Action Buttons -->
  1547	                        <div class="flex space-x-3">
  1548	                            <button onclick="testWixConnection()" 
  1549	                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  1550	                                <i class="fas fa-plug mr-2"></i>Test Connection
  1551	                            </button>
  1552	                            <button onclick="startWixSync()" 
  1553	                                    class="flex-1 bg-sage-600 hover:bg-sage-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  1554	                                <i class="fas fa-download mr-2"></i>Import Orders
  1555	                            </button>
  1556	                            <button onclick="closeWixModal()" 
  1557	                                    class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
  1558	                                Cancel
  1559	                            </button>
  1560	                        </div>
  1561	
  1562	                        <!-- Help Section -->
  1563	                        <div class="mt-6 p-4 bg-amber-50 rounded-lg">
  1564	                            <h4 class="text-sm font-semibold text-amber-900 mb-2">ðŸ”§ Manufacturing Tool - Internal Use:</h4>
  1565	                            <ul class="text-xs text-amber-800 space-y-1">
  1566	                                <li>â€¢ <strong>Purpose</strong>: Auto-import Star Seed's Wix orders for manufacturing invoicing</li>
  1567	                                <li>â€¢ <strong>Workflow</strong>: Pull orders â†’ Map to manufacturing costs â†’ Generate invoices</li>
  1568	                                <li>â€¢ <strong>Credentials</strong>: Pre-configured for Star Seed Natural store access</li>
  1569	                                <li>â€¢ <strong>Data Use</strong>: Transform e-commerce orders into B2B manufacturing invoices</li>
  1570	                            </ul>
  1571	                            <p class="text-xs text-amber-700 mt-2 font-medium">This streamlines your monthly invoicing process - no more manual order tracking!</p>
  1572	                        </div>
  1573	                    </div>
  1574	                </div>
  1575	            `;
  1576	
  1577	            document.body.insertAdjacentHTML('beforeend', wixModalHtml);
  1578	            
  1579	            // Set default date range (last 30 days)
  1580	            const today = new Date();
  1581	            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
  1582	            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
  1583	            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
  1584	        }
  1585	
  1586	        function closeWixModal() {
  1587	            const modal = document.getElementById('wixSyncModal');
  1588	            if (modal) {
  1589	                modal.remove();
  1590	            }
  1591	        }
  1592	
  1593	        async function testWixConnection() {
  1594	            const appId = document.getElementById('wixAppId').value.trim();
  1595	            const secretKey = document.getElementById('wixSecretKey').value.trim();
  1596	            const clientId = document.getElementById('wixClientId').value.trim();
  1597	            
  1598	            if (!appId || !secretKey || !clientId) {
  1599	                showWixStatus('Please enter App ID, Secret Key, and Client ID', 'error');
  1600	                return;
  1601	            }
  1602	
  1603	            showWixStatus('Testing connection and retrieving Store ID...', 'loading');
  1604	
  1605	            try {
  1606	                const response = await fetch('/.netlify/functions/wix-integration', {
  1607	                    method: 'POST',
  1608	                    headers: {
  1609	                        'Content-Type': 'application/json'
  1610	                    },
  1611	                    body: JSON.stringify({
  1612	                        action: 'test_connection',
  1613	                        appId: appId,
  1614	                        secretKey: secretKey,
  1615	                        clientId: clientId
  1616	                    })
  1617	                });
  1618	
  1619	                const result = await response.json();
  1620	
  1621	                if (result.success) {
  1622	                    // Store the credentials and site ID for later use
  1623	                    window.wixCredentials = {
  1624	                        appId,
  1625	                        secretKey,
  1626	                        clientId,
  1627	                        siteId: result.siteId,
  1628	                        accessToken: result.accessToken
  1629	                    };
  1630	                    
  1631	                    showWixStatus(`âœ… Connection successful! Store ID: ${result.siteId}`, 'success');
  1632	                    updateConnectionStatus(true, result);
  1633	                } else {
  1634	                    showWixStatus(`âŒ Connection failed: ${result.error}`, 'error');
  1635	                    updateConnectionStatus(false);
  1636	                }
  1637	            } catch (error) {
  1638	                showWixStatus(`âŒ Connection error: ${error.message}`, 'error');
  1639	                updateConnectionStatus(false);
  1640	            }
  1641	        }
  1642	
  1643	        async function startWixSync() {
  1644	            if (!window.wixCredentials) {
  1645	                showWixStatus('Please test connection first to authenticate with Wix', 'error');
  1646	                return;
  1647	            }
  1648	
  1649	            const syncCustomers = document.getElementById('syncCustomers').checked;
  1650	            const syncOrders = document.getElementById('syncOrders').checked;
  1651	            const dateFrom = document.getElementById('dateFrom').value;
  1652	            const dateTo = document.getElementById('dateTo').value;
  1653	
  1654	            if (!syncCustomers && !syncOrders) {
  1655	                showWixStatus('Please select at least one sync option', 'error');
  1656	                return;
  1657	            }
  1658	
  1659	            showSyncProgress(true);
  1660	            const results = [];
  1661	
  1662	            try {
  1663	                // Sync customers
  1664	                if (syncCustomers) {
  1665	                    updateProgress(25, 'Syncing customers...');
  1666	                    const customerResponse = await fetch('/.netlify/functions/wix-integration', {
  1667	                        method: 'POST',
  1668	                        headers: { 'Content-Type': 'application/json' },
  1669	                        body: JSON.stringify({
  1670	                            action: 'sync_customers',
  1671	                            ...window.wixCredentials
  1672	                        })
  1673	                    });
  1674	                    
  1675	                    const customerResult = await customerResponse.json();
  1676	                    if (customerResult.success) {
  1677	                        results.push(`âœ… Customers: ${customerResult.stats.inserted} new, ${customerResult.stats.updated} updated`);
  1678	                    } else {
  1679	                        results.push(`âŒ Customer sync failed: ${customerResult.error}`);
  1680	                    }
  1681	                }
  1682	
  1683	                // Sync orders
  1684	                if (syncOrders) {
  1685	                    updateProgress(75, 'Syncing orders...');
  1686	                    const orderResponse = await fetch('/.netlify/functions/wix-integration', {
  1687	                        method: 'POST',
  1688	                        headers: { 'Content-Type': 'application/json' },
  1689	                        body: JSON.stringify({
  1690	                            action: 'sync_orders',
  1691	                            ...window.wixCredentials,
  1692	                            dateFrom: dateFrom,
  1693	                            dateTo: dateTo
  1694	                        })
  1695	                    });
  1696	                    
  1697	                    const orderResult = await orderResponse.json();
  1698	                    if (orderResult.success) {
  1699	                        results.push(`âœ… Orders: ${orderResult.stats.inserted} new, ${orderResult.stats.updated} updated`);
  1700	                    } else {
  1701	                        results.push(`âŒ Order sync failed: ${orderResult.error}`);
  1702	                    }
  1703	                }
  1704	
  1705	                updateProgress(100, 'Sync completed!');
  1706	                showSyncResults(results);
  1707	
  1708	            } catch (error) {
  1709	                results.push(`âŒ Sync error: ${error.message}`);
  1710	                showSyncResults(results);
  1711	                updateProgress(0, 'Sync failed');
  1712	            }
  1713	        }
  1714	
  1715	        function showWixStatus(message, type) {
  1716	            const statusDiv = document.getElementById('wixConnectionStatus');
  1717	            const colors = {
  1718	                'success': 'bg-green-50 border-green-200 text-green-800',
  1719	                'error': 'bg-red-50 border-red-200 text-red-800',
  1720	                'loading': 'bg-blue-50 border-blue-200 text-blue-800',
  1721	                'info': 'bg-gray-50 border-gray-200 text-gray-800'
  1722	            };
  1723	
  1724	            const icons = {
  1725	                'success': 'fas fa-check-circle text-green-600',
  1726	                'error': 'fas fa-exclamation-circle text-red-600',
  1727	                'loading': 'fas fa-spinner fa-spin text-blue-600',
  1728	                'info': 'fas fa-info-circle text-gray-600'
  1729	            };
  1730	
  1731	            statusDiv.className = `mb-6 p-4 rounded-lg border ${colors[type] || colors.info}`;
  1732	            statusDiv.innerHTML = `
  1733	                <div class="flex items-center">
  1734	                    <i class="${icons[type] || icons.info} mr-3"></i>
  1735	                    <span class="font-medium">${message}</span>
  1736	                </div>
  1737	            `;
  1738	        }
  1739	
  1740	        function updateConnectionStatus(connected, result = null) {
  1741	            if (connected && result) {
  1742	                // Show the retrieved Store ID
  1743	                document.getElementById('storeIdDisplay').classList.remove('hidden');
  1744	                document.getElementById('retrievedStoreId').textContent = result.siteId;
  1745	                
  1746	                // Update connection status
  1747	                const statusDiv = document.getElementById('wixConnectionStatus');
  1748	                statusDiv.className = 'mb-6 p-4 rounded-lg border bg-green-50 border-green-200 text-green-800';
  1749	                statusDiv.innerHTML = `
  1750	                    <div class="flex items-center">
  1751	                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
  1752	                        <span class="font-medium">Connected to Star Seed Natural Wix Store</span>
  1753	                    </div>
  1754	                    <p class="text-sm mt-1">Store ID: ${result.siteId} â€¢ Ready to sync customers and orders</p>
  1755	                `;
  1756	            }
  1757	        }
  1758	
  1759	        function showSyncProgress(show) {
  1760	            const progressDiv = document.getElementById('wixSyncProgress');
  1761	            progressDiv.classList.toggle('hidden', !show);
  1762	        }
  1763	
  1764	        function updateProgress(percent, text) {
  1765	            document.getElementById('progressBar').style.width = `${percent}%`;
  1766	            document.getElementById('progressPercent').textContent = `${percent}%`;
  1767	            document.getElementById('progressText').textContent = text;
  1768	        }
  1769	
  1770	        function showSyncResults(results) {
  1771	            const resultsDiv = document.getElementById('wixSyncResults');
  1772	            resultsDiv.classList.remove('hidden');
  1773	            resultsDiv.innerHTML = `
  1774	                <div class="p-4 bg-gray-50 rounded-lg">
  1775	                    <h4 class="font-semibold text-gray-900 mb-3">Sync Results:</h4>
  1776	                    <div class="space-y-2">
  1777	                        ${results.map(result => `<div class="text-sm">${result}</div>`).join('')}
  1778	                    </div>
  1779	                </div>
  1780	            `;
  1781	        }
  1782	
  1783	        function showWixDataBrowser() {
  1784	            const browserHtml = `
  1785	                <div id="wixDataBrowser" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
  1786	                    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl w-full max-w-6xl mx-4 h-5/6 flex flex-col border border-sage-200">
  1787	                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
  1788	                            <div class="flex items-center">
  1789	                                <i class="fas fa-database text-blue-600 text-2xl mr-3"></i>
  1790	                                <h2 class="text-2xl font-bold text-gray-900">Wix Data Browser</h2>
  1791	                            </div>
  1792	                            <button onclick="closeWixDataBrowser()" class="text-gray-400 hover:text-gray-600 transition-colors">
  1793	                                <i class="fas fa-times text-xl"></i>
  1794	                            </button>
  1795	                        </div>
  1796	
  1797	                        <div class="flex flex-1 overflow-hidden">
  1798	                            <!-- Sidebar -->
  1799	                            <div class="w-64 bg-gray-50 border-r border-gray-200 p-4">
  1800	                                <nav class="space-y-2">
  1801	                                    <button onclick="loadWixCustomers()" 
  1802	                                            class="w-full text-left px-4 py-2 rounded-lg hover:bg-sage-100 flex items-center wix-nav-item" 
  1803	                                            data-tab="customers">
  1804	                                        <i class="fas fa-users mr-3"></i>
  1805	                                        Customers
  1806	                                        <span id="customersCount" class="ml-auto text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span>
  1807	                                    </button>
  1808	                                    <button onclick="loadWixOrders()" 
  1809	                                            class="w-full text-left px-4 py-2 rounded-lg hover:bg-sage-100 flex items-center wix-nav-item" 
  1810	                                            data-tab="orders">
  1811	                                        <i class="fas fa-shopping-cart mr-3"></i>
  1812	                                        Orders
  1813	                                        <span id="ordersCount" class="ml-auto text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">0</span>
  1814	                                    </button>
  1815	                                    <button onclick="loadWixInvoicingQueue()" 
  1816	                                            class="w-full text-left px-4 py-2 rounded-lg hover:bg-sage-100 flex items-center wix-nav-item" 
  1817	                                            data-tab="invoicing">
  1818	                                        <i class="fas fa-file-invoice-dollar mr-3"></i>
  1819	                                        Ready for Invoicing
  1820	                                        <span id="invoicingCount" class="ml-auto text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">0</span>
  1821	                                    </button>
  1822	                                </nav>
  1823	                                
  1824	                                <div class="mt-6 pt-6 border-t border-gray-200">
  1825	                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Quick Actions</h4>
  1826	                                    <div class="space-y-2">
  1827	                                        <button onclick="createInvoiceFromSelected()" 
  1828	                                                class="w-full px-3 py-2 text-sm bg-sage-600 hover:bg-sage-700 text-white rounded-lg">
  1829	                                            <i class="fas fa-file-invoice-dollar mr-2"></i>Invoice Ed
  1830	                                        </button>
  1831	                                        <button onclick="exportWixData()" 
  1832	                                                class="w-full px-3 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
  1833	                                            <i class="fas fa-download mr-2"></i>Export Orders
  1834	                                        </button>
  1835	                                        <button onclick="calculateManufacturingCosts()" 
  1836	                                                class="w-full px-3 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
  1837	                                            <i class="fas fa-calculator mr-2"></i>Calculate Costs
  1838	                                        </button>
  1839	                                    </div>
  1840	                                </div>
  1841	                            </div>
  1842	
  1843	                            <!-- Main Content -->
  1844	                            <div class="flex-1 p-6 overflow-auto">
  1845	                                <div id="wixDataContent" class="h-full">
  1846	                                    <div class="text-center py-12">
  1847	                                        <i class="fas fa-mouse-pointer text-gray-300 text-6xl mb-4"></i>
  1848	                                        <h3 class="text-lg font-medium text-gray-900 mb-2">Select a data type</h3>
  1849	                                        <p class="text-gray-500">Choose customers, orders, or invoicing queue from the sidebar</p>
  1850	                                    </div>
  1851	                                </div>
  1852	                            </div>
  1853	                        </div>
  1854	                    </div>
  1855	                </div>
  1856	            `;
  1857	
  1858	            document.body.insertAdjacentHTML('beforeend', browserHtml);
  1859	            loadWixDataCounts();
  1860	        }
  1861	
  1862	        function closeWixDataBrowser() {
  1863	            const browser = document.getElementById('wixDataBrowser');
  1864	            if (browser) {
  1865	                browser.remove();
  1866	            }
  1867	        }
  1868	
  1869	        async function loadWixDataCounts() {
  1870	            try {
  1871	                // Load data counts for the sidebar badges
  1872	                const response = await fetch('/.netlify/functions/db-query', {
  1873	                    method: 'POST',
  1874	                    headers: { 'Content-Type': 'application/json' },
  1875	                    body: JSON.stringify({
  1876	                        action: 'query',
  1877	                        query: 'SELECT (SELECT COUNT(*) FROM wix_customers) as customers, (SELECT COUNT(*) FROM wix_orders) as orders'
  1878	                    })
  1879	                });
  1880	
  1881	                const result = await response.json();
  1882	                if (result.success && result.data.length > 0) {
  1883	                    document.getElementById('customersCount').textContent = result.data[0].customers || 0;
  1884	                    document.getElementById('ordersCount').textContent = result.data[0].orders || 0;
  1885	                    
  1886	                    // Calculate invoicing queue (orders with specific statuses)
  1887	                    const invoicingResponse = await fetch('/.netlify/functions/db-query', {
  1888	                        method: 'POST',
  1889	                        headers: { 'Content-Type': 'application/json' },
  1890	                        body: JSON.stringify({
  1891	                            action: 'query',
  1892	                            query: "SELECT COUNT(*) as count FROM wix_orders WHERE status IN ('PAID', 'FULFILLED') AND payment_status = 'PAID'"
  1893	                        })
  1894	                    });
  1895	
  1896	                    const invoicingResult = await invoicingResponse.json();
  1897	                    if (invoicingResult.success && invoicingResult.data.length > 0) {
  1898	                        document.getElementById('invoicingCount').textContent = invoicingResult.data[0].count || 0;
  1899	                    }
  1900	                }
  1901	            } catch (error) {
  1902	                console.error('Error loading Wix data counts:', error);
  1903	            }
  1904	        }
  1905	
  1906	        async function loadWixCustomers() {
  1907	            setActiveTab('customers');
  1908	            const content = document.getElementById('wixDataContent');
  1909	            content.innerHTML = `
  1910	                <div class="flex justify-between items-center mb-6">
  1911	                    <h3 class="text-xl font-semibold text-gray-900">Wix Customers</h3>
  1912	                    <div class="flex space-x-2">
  1913	                        <input type="search" id="customerSearch" placeholder="Search customers..." 
  1914	                               class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
  1915	                        <button onclick="refreshCustomers()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">
  1916	                            <i class="fas fa-sync"></i>
  1917	                        </button>
  1918	                    </div>
  1919	                </div>
  1920	                <div id="customersTable" class="bg-white rounded-lg shadow overflow-hidden">
  1921	                    <div class="p-6 text-center">
  1922	                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
  1923	                        <p class="text-gray-500">Loading customers...</p>
  1924	                    </div>
  1925	                </div>
  1926	            `;
  1927	
  1928	            try {
  1929	                const response = await fetch('/.netlify/functions/db-query', {
  1930	                    method: 'POST',
  1931	                    headers: { 'Content-Type': 'application/json' },
  1932	                    body: JSON.stringify({
  1933	                        action: 'query',
  1934	                        query: 'SELECT * FROM wix_customers ORDER BY sync_date DESC LIMIT 100'
  1935	                    })
  1936	                });
  1937	
  1938	                const result = await response.json();
  1939	                if (result.success) {
  1940	                    displayCustomersTable(result.data);
  1941	                } else {
  1942	                    throw new Error(result.error);
  1943	                }
  1944	            } catch (error) {
  1945	                document.getElementById('customersTable').innerHTML = `
  1946	                    <div class="p-6 text-center">
  1947	                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
  1948	                        <p class="text-red-600">Error loading customers: ${error.message}</p>
  1949	                    </div>
  1950	                `;
  1951	            }
  1952	        }
  1953	
  1954	        async function loadWixOrders() {
  1955	            setActiveTab('orders');
  1956	            const content = document.getElementById('wixDataContent');
  1957	            content.innerHTML = `
  1958	                <div class="flex justify-between items-center mb-6">
  1959	                    <h3 class="text-xl font-semibold text-gray-900">Wix Orders</h3>
  1960	                    <div class="flex space-x-2">
  1961	                        <select id="orderStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
  1962	                            <option value="">All Statuses</option>
  1963	                            <option value="PAID">Paid</option>
  1964	                            <option value="FULFILLED">Fulfilled</option>
  1965	                            <option value="PENDING">Pending</option>
  1966	                        </select>
  1967	                        <input type="search" id="orderSearch" placeholder="Search orders..." 
  1968	                               class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
  1969	                        <button onclick="refreshOrders()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">
  1970	                            <i class="fas fa-sync"></i>
  1971	                        </button>
  1972	                    </div>
  1973	                </div>
  1974	                <div id="ordersTable" class="bg-white rounded-lg shadow overflow-hidden">
  1975	                    <div class="p-6 text-center">
  1976	                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
  1977	                        <p class="text-gray-500">Loading orders...</p>
  1978	                    </div>
  1979	                </div>
  1980	            `;
  1981	
  1982	            try {
  1983	                const response = await fetch('/.netlify/functions/db-query', {
  1984	                    method: 'POST',
  1985	                    headers: { 'Content-Type': 'application/json' },
  1986	                    body: JSON.stringify({
  1987	                        action: 'query',
  1988	                        query: 'SELECT * FROM wix_orders ORDER BY date_created DESC LIMIT 100'
  1989	                    })
  1990	                });
  1991	
  1992	                const result = await response.json();
  1993	                if (result.success) {
  1994	                    displayOrdersTable(result.data);
  1995	                } else {
  1996	                    throw new Error(result.error);
  1997	                }
  1998	            } catch (error) {
  1999	                document.getElementById('ordersTable').innerHTML = `
  2000	                    <div class="p-6 text-center">
  2001	                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
  2002	                        <p class="text-red-600">Error loading orders: ${error.message}</p>
  2003	                    </div>
  2004	                `;
  2005	            }
  2006	        }
  2007	
  2008	        async function loadWixInvoicingQueue() {
  2009	            setActiveTab('invoicing');
  2010	            const content = document.getElementById('wixDataContent');
  2011	            content.innerHTML = `
  2012	                <div class="flex justify-between items-center mb-6">
  2013	                    <h3 class="text-xl font-semibold text-gray-900">Ready for Invoicing</h3>
  2014	                    <div class="flex space-x-2">
  2015	                        <button onclick="selectAllInvoicing()" class="px-3 py-2 bg-sage-600 text-white rounded-lg text-sm">
  2016	                            Select All
  2017	                        </button>
  2018	                        <button onclick="createBulkInvoices()" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">
  2019	                            <i class="fas fa-file-invoice-dollar mr-1"></i>Create Invoices
  2020	                        </button>
  2021	                    </div>
  2022	                </div>
  2023	                <div id="invoicingTable" class="bg-white rounded-lg shadow overflow-hidden">
  2024	                    <div class="p-6 text-center">
  2025	                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
  2026	                        <p class="text-gray-500">Loading orders ready for invoicing...</p>
  2027	                    </div>
  2028	                </div>
  2029	            `;
  2030	
  2031	            try {
  2032	                const response = await fetch('/.netlify/functions/db-query', {
  2033	                    method: 'POST',
  2034	                    headers: { 'Content-Type': 'application/json' },
  2035	                    body: JSON.stringify({
  2036	                        action: 'query',
  2037	                        query: "SELECT * FROM wix_orders WHERE status IN ('PAID', 'FULFILLED') AND payment_status = 'PAID' ORDER BY date_created DESC"
  2038	                    })
  2039	                });
  2040	
  2041	                const result = await response.json();
  2042	                if (result.success) {
  2043	                    displayInvoicingTable(result.data);
  2044	                } else {
  2045	                    throw new Error(result.error);
  2046	                }
  2047	            } catch (error) {
  2048	                document.getElementById('invoicingTable').innerHTML = `
  2049	                    <div class="p-6 text-center">
  2050	                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
  2051	                        <p class="text-red-600">Error loading invoicing queue: ${error.message}</p>
  2052	                    </div>
  2053	                `;
  2054	            }
  2055	        }
  2056	
  2057	        function setActiveTab(tab) {
  2058	            document.querySelectorAll('.wix-nav-item').forEach(item => {
  2059	                item.classList.remove('bg-sage-100');
  2060	            });
  2061	            document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-sage-100');
  2062	        }
  2063	
  2064	        function displayCustomersTable(customers) {
  2065	            if (!customers || customers.length === 0) {
  2066	                document.getElementById('customersTable').innerHTML = `
  2067	                    <div class="p-6 text-center">
  2068	                        <i class="fas fa-users text-gray-300 text-4xl mb-4"></i>
  2069	                        <h3 class="text-lg font-medium text-gray-900 mb-2">No customers found</h3>
  2070	                        <p class="text-gray-500">Sync from Wix to import customer data</p>
  2071	                    </div>
  2072	                `;
  2073	                return;
  2074	            }
  2075	
  2076	            const tableHtml = `
  2077	                <table class="min-w-full">
  2078	                    <thead class="bg-gray-50">
  2079	                        <tr>
  2080	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
  2081	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
  2082	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
  2083	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Created</th>
  2084	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Synced</th>
  2085	                        </tr>
  2086	                    </thead>
  2087	                    <tbody class="divide-y divide-gray-200">
  2088	                        ${customers.map(customer => `
  2089	                            <tr class="hover:bg-gray-50">
  2090	                                <td class="px-6 py-4 whitespace-nowrap">
  2091	                                    <div class="text-sm font-medium text-gray-900">${customer.first_name || ''} ${customer.last_name || ''}</div>
  2092	                                    <div class="text-sm text-gray-500">ID: ${customer.wix_customer_id}</div>
  2093	                                </td>
  2094	                                <td class="px-6 py-4 whitespace-nowrap">
  2095	                                    <div class="text-sm text-gray-900">${customer.email || 'N/A'}</div>
  2096	                                </td>
  2097	                                <td class="px-6 py-4 whitespace-nowrap">
  2098	                                    <div class="text-sm text-gray-900">${customer.phone || 'N/A'}</div>
  2099	                                </td>
  2100	                                <td class="px-6 py-4 whitespace-nowrap">
  2101	                                    <div class="text-sm text-gray-900">${customer.date_created ? new Date(customer.date_created).toLocaleDateString() : 'N/A'}</div>
  2102	                                </td>
  2103	                                <td class="px-6 py-4 whitespace-nowrap">
  2104	                                    <div class="text-sm text-gray-500">${customer.sync_date ? new Date(customer.sync_date).toLocaleDateString() : 'N/A'}</div>
  2105	                                </td>
  2106	                            </tr>
  2107	                        `).join('')}
  2108	                    </tbody>
  2109	                </table>
  2110	            `;
  2111	
  2112	            document.getElementById('customersTable').innerHTML = tableHtml;
  2113	        }
  2114	
  2115	        function displayOrdersTable(orders) {
  2116	            if (!orders || orders.length === 0) {
  2117	                document.getElementById('ordersTable').innerHTML = `
  2118	                    <div class="p-6 text-center">
  2119	                        <i class="fas fa-shopping-cart text-gray-300 text-4xl mb-4"></i>
  2120	                        <h3 class="text-lg font-medium text-gray-900 mb-2">No orders found</h3>
  2121	                        <p class="text-gray-500">Sync from Wix to import order data</p>
  2122	                    </div>
  2123	                `;
  2124	                return;
  2125	            }
  2126	
  2127	            const tableHtml = `
  2128	                <table class="min-w-full">
  2129	                    <thead class="bg-gray-50">
  2130	                        <tr>
  2131	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order</th>
  2132	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
  2133	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
  2134	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
  2135	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
  2136	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
  2137	                        </tr>
  2138	                    </thead>
  2139	                    <tbody class="divide-y divide-gray-200">
  2140	                        ${orders.map(order => `
  2141	                            <tr class="hover:bg-gray-50">
  2142	                                <td class="px-6 py-4 whitespace-nowrap">
  2143	                                    <div class="text-sm font-medium text-gray-900">${order.order_number || 'N/A'}</div>
  2144	                                    <div class="text-sm text-gray-500">ID: ${order.wix_order_id}</div>
  2145	                                </td>
  2146	                                <td class="px-6 py-4 whitespace-nowrap">
  2147	                                    <div class="text-sm text-gray-900">${order.customer_name || 'N/A'}</div>
  2148	                                    <div class="text-sm text-gray-500">${order.customer_email || 'N/A'}</div>
  2149	                                </td>
  2150	                                <td class="px-6 py-4 whitespace-nowrap">
  2151	                                    <div class="text-xs space-y-1">
  2152	                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
  2153	                                            ${order.status || 'Unknown'}
  2154	                                        </span>
  2155	                                        <br>
  2156	                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
  2157	                                            ${order.payment_status || 'Unknown'}
  2158	                                        </span>
  2159	                                    </div>
  2160	                                </td>
  2161	                                <td class="px-6 py-4 whitespace-nowrap">
  2162	                                    <div class="text-sm font-medium text-gray-900">Â£${parseFloat(order.total_amount || 0).toFixed(2)}</div>
  2163	                                    <div class="text-sm text-gray-500">${order.currency || 'GBP'}</div>
  2164	                                </td>
  2165	                                <td class="px-6 py-4 whitespace-nowrap">
  2166	                                    <div class="text-sm text-gray-900">${order.date_created ? new Date(order.date_created).toLocaleDateString() : 'N/A'}</div>
  2167	                                </td>
  2168	                                <td class="px-6 py-4 whitespace-nowrap">
  2169	                                    <button onclick="createInvoiceFromOrder('${order.wix_order_id}')" 
  2170	                                            class="text-sage-600 hover:text-sage-900 text-sm">
  2171	                                        <i class="fas fa-file-invoice mr-1"></i>Invoice
  2172	                                    </button>
  2173	                                </td>
  2174	                            </tr>
  2175	                        `).join('')}
  2176	                    </tbody>
  2177	                </table>
  2178	            `;
  2179	
  2180	            document.getElementById('ordersTable').innerHTML = tableHtml;
  2181	        }
  2182	
  2183	        function displayInvoicingTable(orders) {
  2184	            if (!orders || orders.length === 0) {
  2185	                document.getElementById('invoicingTable').innerHTML = `
  2186	                    <div class="p-6 text-center">
  2187	                        <i class="fas fa-file-invoice-dollar text-gray-300 text-4xl mb-4"></i>
  2188	                        <h3 class="text-lg font-medium text-gray-900 mb-2">No orders ready for manufacturing invoicing</h3>
  2189	                        <p class="text-gray-500">Import orders from Wix to see what needs to be invoiced</p>
  2190	                    </div>
  2191	                `;
  2192	                return;
  2193	            }
  2194	
  2195	            const tableHtml = `
  2196	                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
  2197	                    <div class="flex items-center">
  2198	                        <i class="fas fa-industry text-blue-600 mr-2"></i>
  2199	                        <span class="text-sm text-blue-800">
  2200	                            <strong>${orders.length}</strong> Star Seed orders ready for manufacturing invoicing. These represent products you need to produce and bill for.
  2201	                        </span>
  2202	                    </div>
  2203	                    <div class="mt-2 text-xs text-blue-700">
  2204	                        ðŸ’¡ <strong>Your workflow:</strong> Select orders â†’ Generate manufacturing invoices â†’ Send to Ed with production timeline
  2205	                    </div>
  2206	                </div>
  2207	                <table class="min-w-full">
  2208	                    <thead class="bg-gray-50">
  2209	                        <tr>
  2210	                            <th class="px-4 py-3 text-left">
  2211	                                <input type="checkbox" id="selectAllInvoicing" onchange="toggleAllInvoicing()" 
  2212	                                       class="rounded border-gray-300 text-sage-600 focus:ring-sage-500">
  2213	                            </th>
  2214	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wix Order</th>
  2215	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">End Customer</th>
  2216	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Manufacturing Value</th>
  2217	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order Date</th>
  2218	                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Products to Manufacture</th>
  2219	                        </tr>
  2220	                    </thead>
  2221	                    <tbody class="divide-y divide-gray-200">
  2222	                        ${orders.map(order => `
  2223	                            <tr class="hover:bg-gray-50">
  2224	                                <td class="px-4 py-4">
  2225	                                    <input type="checkbox" class="invoicing-checkbox rounded border-gray-300 text-sage-600 focus:ring-sage-500" 
  2226	                                           value="${order.wix_order_id}">
  2227	                                </td>
  2228	                                <td class="px-6 py-4 whitespace-nowrap">
  2229	                                    <div class="text-sm font-medium text-gray-900">${order.order_number || 'N/A'}</div>
  2230	                                    <div class="text-sm text-gray-500">ID: ${order.wix_order_id}</div>
  2231	                                </td>
  2232	                                <td class="px-6 py-4 whitespace-nowrap">
  2233	                                    <div class="text-sm text-gray-900">${order.customer_name || 'N/A'}</div>
  2234	                                    <div class="text-sm text-gray-500">${order.customer_email || 'N/A'}</div>
  2235	                                </td>
  2236	                                <td class="px-6 py-4 whitespace-nowrap">
  2237	                                    <div class="text-sm font-medium text-gray-900">Â£${parseFloat(order.total_amount || 0).toFixed(2)}</div>
  2238	                                    <div class="text-xs text-sage-600 font-medium">Invoice Ed: Â£${(parseFloat(order.total_amount || 0) * 0.5).toFixed(2)} + Manufacturing</div>
  2239	                                </td>
  2240	                                <td class="px-6 py-4 whitespace-nowrap">
  2241	                                    <div class="text-sm text-gray-900">${order.date_created ? new Date(order.date_created).toLocaleDateString() : 'N/A'}</div>
  2242	                                </td>
  2243	                                <td class="px-6 py-4">
  2244	                                    <div class="text-sm text-gray-900">
  2245	                                        ${order.line_items ? JSON.parse(order.line_items).length : 0} products
  2246	                                    </div>
  2247	                                    <div class="text-xs text-gray-500">Need manufacturing quote</div>
  2248	                                </td>
  2249	                            </tr>
  2250	                        `).join('')}
  2251	                    </tbody>
  2252	                </table>
  2253	            `;
  2254	
  2255	            document.getElementById('invoicingTable').innerHTML = tableHtml;
  2256	        }
  2257	
  2258	        // Additional helper functions for the Wix data browser
  2259	        function toggleAllInvoicing() {
  2260	            const selectAll = document.getElementById('selectAllInvoicing');
  2261	            const checkboxes = document.querySelectorAll('.invoicing-checkbox');
  2262	            checkboxes.forEach(cb => cb.checked = selectAll.checked);
  2263	        }
  2264	
  2265	        async function createInvoiceFromOrder(wixOrderId) {
  2266	            showStatus(`ðŸ“§ Creating invoice for order ${wixOrderId} - Feature in development`, 'info');
  2267	        }
  2268	
  2269	        async function createBulkInvoices() {
  2270	            const selectedOrders = Array.from(document.querySelectorAll('.invoicing-checkbox:checked')).map(cb => cb.value);
  2271	            if (selectedOrders.length === 0) {
  2272	                showStatus('Please select at least one order to invoice Ed for', 'error');
  2273	                return;
  2274	            }
  2275	            showStatus(`ðŸ“§ Creating manufacturing invoice for ${selectedOrders.length} orders - Feature in development`, 'info');
  2276	        }
  2277	
  2278	        async function exportWixData() {
  2279	            showStatus('ðŸ“¥ Exporting order data for manufacturing planning - Feature in development', 'info');
  2280	        }
  2281	
  2282	        async function calculateManufacturingCosts() {
  2283	            const selectedOrders = Array.from(document.querySelectorAll('.invoicing-checkbox:checked')).map(cb => cb.value);
  2284	            if (selectedOrders.length === 0) {
  2285	                showStatus('Please select orders to calculate manufacturing costs for', 'error');
  2286	                return;
  2287	            }
  2288	            
  2289	            // This would integrate with your formulation calculator
  2290	            showStatus(`ðŸ§® Calculating manufacturing costs for ${selectedOrders.length} orders - Integration with formulation calculator coming soon`, 'info');
  2291	        }
  2292	
  2293	        // Asana Integration Functions
  2294	        function syncAsanaData() {
  2295	            showAsanaSyncInterface();
  2296	        }
  2297	
  2298	        function showAsanaSyncInterface() {
  2299	            const asanaModalHtml = `
  2300	                <div id="asanaSyncModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
  2301	                    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4 border border-sage-200">
  2302	                        <div class="flex items-center justify-between mb-6">
  2303	                            <div class="flex items-center">
  2304	                                <i class="fas fa-tasks text-purple-600 text-2xl mr-3"></i>
  2305	                                <h2 class="text-2xl font-bold text-gray-900">Asana Task Import</h2>
  2306	                            </div>
  2307	                            <button onclick="closeAsanaModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
  2308	                                <i class="fas fa-times text-xl"></i>
  2309	                            </button>
  2310	                        </div>
  2311	
  2312	                        <!-- Connection Status -->
  2313	                        <div id="asanaConnectionStatus" class="mb-6 p-4 rounded-lg border">
  2314	                            <div class="flex items-center">
  2315	                                <div class="animate-pulse w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
  2316	                                <span class="font-medium text-gray-900">Connection Status: Not Connected</span>
  2317	                            </div>
  2318	                            <p class="text-sm text-gray-600 mt-1">Enter your Asana Personal Access Token</p>
  2319	                        </div>
  2320	
  2321	                        <!-- API Configuration -->
  2322	                        <div class="space-y-4 mb-6">
  2323	                            <div>
  2324	                                <label for="asanaAccessToken" class="block text-sm font-medium text-gray-700 mb-2">
  2325	                                    Personal Access Token <span class="text-red-500">*</span>
  2326	                                </label>
  2327	                                <input type="password" id="asanaAccessToken" 
  2328	                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 focus:border-sage-500"
  2329	                                       placeholder="Enter your Asana Personal Access Token">
  2330	                                <p class="text-xs text-gray-500 mt-1">Get this from Asana â†’ My Settings â†’ Apps â†’ Personal Access Tokens</p>
  2331	                            </div>
  2332	
  2333	                            <div id="projectSelection" class="hidden">
  2334	                                <label for="asanaProject" class="block text-sm font-medium text-gray-700 mb-2">Project (Optional)</label>
  2335	                                <select id="asanaProject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500">
  2336	                                    <option value="all">All Projects</option>
  2337	                                </select>
  2338	                            </div>
  2339	                        </div>
  2340	
  2341	                        <!-- Import Options -->
  2342	                        <div class="mb-6">
  2343	                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Import Options</h3>
  2344	                            <div class="grid grid-cols-2 gap-4">
  2345	                                <div class="space-y-3">
  2346	                                    <label class="flex items-center">
  2347	                                        <input type="checkbox" id="includeCompleted" 
  2348	                                               class="rounded border-gray-300 text-sage-600 focus:ring-sage-500">
  2349	                                        <span class="ml-3 text-sm text-gray-900">Include Completed Tasks</span>
  2350	                                    </label>
  2351	                                    <label class="flex items-center">
  2352	                                        <input type="checkbox" id="manufacturingOnly" checked 
  2353	                                               class="rounded border-gray-300 text-sage-600 focus:ring-sage-500">
  2354	                                        <span class="ml-3 text-sm text-gray-900">Manufacturing Tasks Only</span>
  2355	                                    </label>
  2356	                                </div>
  2357	                                <div class="space-y-3">
  2358	                                    <div>
  2359	                                        <label for="taskDateFrom" class="block text-xs text-gray-600 mb-1">Tasks From</label>
  2360	                                        <input type="date" id="taskDateFrom" 
  2361	                                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-sage-500">
  2362	                                    </div>
  2363	                                    <div>
  2364	                                        <label for="taskDateTo" class="block text-xs text-gray-600 mb-1">Tasks To</label>
  2365	                                        <input type="date" id="taskDateTo" 
  2366	                                               class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-sage-500">
  2367	                                    </div>
  2368	                                </div>
  2369	                            </div>
  2370	                        </div>
  2371	
  2372	                        <!-- Progress Bar -->
  2373	                        <div id="asanaSyncProgress" class="hidden mb-6">
  2374	                            <div class="flex justify-between text-sm text-gray-600 mb-2">
  2375	                                <span id="asanaProgressText">Initializing sync...</span>
  2376	                                <span id="asanaProgressPercent">0%</span>
  2377	                            </div>
  2378	                            <div class="w-full bg-gray-200 rounded-full h-2">
  2379	                                <div id="asanaProgressBar" class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
  2380	                            </div>
  2381	                        </div>
  2382	
  2383	                        <!-- Sync Results -->
  2384	                        <div id="asanaSyncResults" class="hidden mb-6"></div>
  2385	
  2386	                        <!-- Action Buttons -->
  2387	                        <div class="flex space-x-3">
  2388	                            <button onclick="testAsanaConnection()" 
  2389	                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  2390	                                <i class="fas fa-plug mr-2"></i>Test Connection
  2391	                            </button>
  2392	                            <button onclick="startAsanaSync()" 
  2393	                                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  2394	                                <i class="fas fa-download mr-2"></i>Import Tasks
  2395	                            </button>
  2396	                            <button onclick="closeAsanaModal()" 
  2397	                                    class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
  2398	                                Cancel
  2399	                            </button>
  2400	                        </div>
  2401	
  2402	                        <!-- Help Section -->
  2403	                        <div class="mt-6 p-4 bg-purple-50 rounded-lg">
  2404	                            <h4 class="text-sm font-semibold text-purple-900 mb-2">ðŸ”§ Ed's Task Import - Manufacturing Tool:</h4>
  2405	                            <ul class="text-xs text-purple-800 space-y-1">
  2406	                                <li>â€¢ <strong>Purpose</strong>: Import Ed's task assignments for offline orders and special requests</li>
  2407	                                <li>â€¢ <strong>Captures</strong>: Sample requests, custom formulations, production orders, quotes</li>
  2408	                                <li>â€¢ <strong>Workflow</strong>: Tasks from Ed â†’ Manufacturing tasks â†’ Invoice line items</li>
  2409	                                <li>â€¢ <strong>Integration</strong>: Combines with Wix orders for complete invoicing picture</li>
  2410	                            </ul>
  2411	                            <p class="text-xs text-purple-700 mt-2 font-medium">No more missed offline orders - everything Ed assigns you gets captured!</p>
  2412	                        </div>
  2413	                    </div>
  2414	                </div>
  2415	            `;
  2416	
  2417	            document.body.insertAdjacentHTML('beforeend', asanaModalHtml);
  2418	            
  2419	            // Set default date range (last 60 days for tasks)
  2420	            const today = new Date();
  2421	            const sixtyDaysAgo = new Date(today.getTime() - (60 * 24 * 60 * 60 * 1000));
  2422	            document.getElementById('taskDateTo').value = today.toISOString().split('T')[0];
  2423	            document.getElementById('taskDateFrom').value = sixtyDaysAgo.toISOString().split('T')[0];
  2424	        }
  2425	
  2426	        function closeAsanaModal() {
  2427	            const modal = document.getElementById('asanaSyncModal');
  2428	            if (modal) {
  2429	                modal.remove();
  2430	            }
  2431	        }
  2432	
  2433	        async function testAsanaConnection() {
  2434	            const accessToken = document.getElementById('asanaAccessToken').value.trim();
  2435	            
  2436	            if (!accessToken) {
  2437	                showAsanaStatus('Please enter your Asana Personal Access Token', 'error');
  2438	                return;
  2439	            }
  2440	
  2441	            showAsanaStatus('Testing Asana connection...', 'loading');
  2442	
  2443	            try {
  2444	                const response = await fetch('/.netlify/functions/asana-integration', {
  2445	                    method: 'POST',
  2446	                    headers: { 'Content-Type': 'application/json' },
  2447	                    body: JSON.stringify({
  2448	                        action: 'test_connection',
  2449	                        accessToken: accessToken
  2450	                    })
  2451	                });
  2452	
  2453	                const result = await response.json();
  2454	
  2455	                if (result.success) {
  2456	                    showAsanaStatus(`âœ… Connected as ${result.user.name} (${result.user.email})`, 'success');
  2457	                    
  2458	                    // Load projects
  2459	                    await loadAsanaProjects(accessToken);
  2460	                    
  2461	                    // Store credentials
  2462	                    window.asanaCredentials = { accessToken };
  2463	                    updateAsanaConnectionStatus(true, result.user);
  2464	                } else {
  2465	                    showAsanaStatus(`âŒ Connection failed: ${result.error}`, 'error');
  2466	                    updateAsanaConnectionStatus(false);
  2467	                }
  2468	            } catch (error) {
  2469	                showAsanaStatus(`âŒ Connection error: ${error.message}`, 'error');
  2470	                updateAsanaConnectionStatus(false);
  2471	            }
  2472	        }
  2473	
  2474	        async function loadAsanaProjects(accessToken) {
  2475	            try {
  2476	                const response = await fetch('/.netlify/functions/asana-integration', {
  2477	                    method: 'POST',
  2478	                    headers: { 'Content-Type': 'application/json' },
  2479	                    body: JSON.stringify({
  2480	                        action: 'get_projects',
  2481	                        accessToken: accessToken
  2482	                    })
  2483	                });
  2484	
  2485	                const result = await response.json();
  2486	
  2487	                if (result.success) {
  2488	                    const projectSelect = document.getElementById('asanaProject');
  2489	                    projectSelect.innerHTML = '<option value="all">All Projects</option>';
  2490	                    
  2491	                    result.projects.forEach(project => {
  2492	                        const option = document.createElement('option');
  2493	                        option.value = project.gid;
  2494	                        option.textContent = project.name;
  2495	                        projectSelect.appendChild(option);
  2496	                    });
  2497	
  2498	                    document.getElementById('projectSelection').classList.remove('hidden');
  2499	                }
  2500	            } catch (error) {
  2501	                console.error('Failed to load projects:', error);
  2502	            }
  2503	        }
  2504	
  2505	        async function startAsanaSync() {
  2506	            if (!window.asanaCredentials) {
  2507	                showAsanaStatus('Please test connection first', 'error');
  2508	                return;
  2509	            }
  2510	
  2511	            const projectId = document.getElementById('asanaProject').value;
  2512	            const includeCompleted = document.getElementById('includeCompleted').checked;
  2513	            const manufacturingOnly = document.getElementById('manufacturingOnly').checked;
  2514	            const dateFrom = document.getElementById('taskDateFrom').value;
  2515	            const dateTo = document.getElementById('taskDateTo').value;
  2516	
  2517	            showAsanaSyncProgress(true);
  2518	            updateAsanaProgress(25, 'Importing tasks from Asana...');
  2519	
  2520	            try {
  2521	                // Get user info for assignee filter
  2522	                const userResponse = await fetch('/.netlify/functions/asana-integration', {
  2523	                    method: 'POST',
  2524	                    headers: { 'Content-Type': 'application/json' },
  2525	                    body: JSON.stringify({
  2526	                        action: 'get_user_info',
  2527	                        accessToken: window.asanaCredentials.accessToken
  2528	                    })
  2529	                });
  2530	
  2531	                const userResult = await userResponse.json();
  2532	                const assigneeId = userResult.success ? userResult.user.gid : null;
  2533	
  2534	                updateAsanaProgress(50, 'Syncing manufacturing tasks...');
  2535	
  2536	                // Sync tasks
  2537	                const syncResponse = await fetch('/.netlify/functions/asana-integration', {
  2538	                    method: 'POST',
  2539	                    headers: { 'Content-Type': 'application/json' },
  2540	                    body: JSON.stringify({
  2541	                        action: 'sync_tasks',
  2542	                        accessToken: window.asanaCredentials.accessToken,
  2543	                        projectId: projectId === 'all' ? null : projectId,
  2544	                        assigneeId: assigneeId,
  2545	                        dateFrom: dateFrom,
  2546	                        dateTo: dateTo
  2547	                    })
  2548	                });
  2549	
  2550	                const syncResult = await syncResponse.json();
  2551	
  2552	                updateAsanaProgress(100, 'Import completed!');
  2553	
  2554	                if (syncResult.success) {
  2555	                    const results = [
  2556	                        `âœ… Total tasks found: ${syncResult.stats.total}`,
  2557	                        `âœ… Manufacturing tasks: ${syncResult.stats.manufacturing_tasks}`,
  2558	                        `âœ… New tasks: ${syncResult.stats.inserted}`,
  2559	                        `âœ… Updated tasks: ${syncResult.stats.updated}`
  2560	                    ];
  2561	                    showAsanaSyncResults(results);
  2562	                } else {
  2563	                    showAsanaSyncResults([`âŒ Sync failed: ${syncResult.error}`]);
  2564	                }
  2565	
  2566	            } catch (error) {
  2567	                updateAsanaProgress(0, 'Import failed');
  2568	                showAsanaSyncResults([`âŒ Import error: ${error.message}`]);
  2569	            }
  2570	        }
  2571	
  2572	        function showAsanaStatus(message, type) {
  2573	            const statusDiv = document.getElementById('asanaConnectionStatus');
  2574	            const colors = {
  2575	                'success': 'bg-green-50 border-green-200 text-green-800',
  2576	                'error': 'bg-red-50 border-red-200 text-red-800',
  2577	                'loading': 'bg-blue-50 border-blue-200 text-blue-800',
  2578	                'info': 'bg-gray-50 border-gray-200 text-gray-800'
  2579	            };
  2580	
  2581	            const icons = {
  2582	                'success': 'fas fa-check-circle text-green-600',
  2583	                'error': 'fas fa-exclamation-circle text-red-600',
  2584	                'loading': 'fas fa-spinner fa-spin text-blue-600',
  2585	                'info': 'fas fa-info-circle text-gray-600'
  2586	            };
  2587	
  2588	            statusDiv.className = `mb-6 p-4 rounded-lg border ${colors[type] || colors.info}`;
  2589	            statusDiv.innerHTML = `
  2590	                <div class="flex items-center">
  2591	                    <i class="${icons[type] || icons.info} mr-3"></i>
  2592	                    <span class="font-medium">${message}</span>
  2593	                </div>
  2594	            `;
  2595	        }
  2596	
  2597	        function updateAsanaConnectionStatus(connected, user = null) {
  2598	            if (connected && user) {
  2599	                const statusDiv = document.getElementById('asanaConnectionStatus');
  2600	                statusDiv.className = 'mb-6 p-4 rounded-lg border bg-green-50 border-green-200 text-green-800';
  2601	                statusDiv.innerHTML = `
  2602	                    <div class="flex items-center">
  2603	                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
  2604	                        <span class="font-medium">Connected to Asana as ${user.name}</span>
  2605	                    </div>
  2606	                    <p class="text-sm mt-1">Ready to import tasks assigned to you by Ed</p>
  2607	                `;
  2608	            }
  2609	        }
  2610	
  2611	        function showAsanaSyncProgress(show) {
  2612	            document.getElementById('asanaSyncProgress').classList.toggle('hidden', !show);
  2613	        }
  2614	
  2615	        function updateAsanaProgress(percent, text) {
  2616	            document.getElementById('asanaProgressBar').style.width = `${percent}%`;
  2617	            document.getElementById('asanaProgressPercent').textContent = `${percent}%`;
  2618	            document.getElementById('asanaProgressText').textContent = text;
  2619	        }
  2620	
  2621	        function showAsanaSyncResults(results) {
  2622	            const resultsDiv = document.getElementById('asanaSyncResults');
  2623	            resultsDiv.classList.remove('hidden');
  2624	            resultsDiv.innerHTML = `
  2625	                <div class="p-4 bg-gray-50 rounded-lg">
  2626	                    <h4 class="font-semibold text-gray-900 mb-3">Import Results:</h4>
  2627	                    <div class="space-y-2">
  2628	                        ${results.map(result => `<div class="text-sm">${result}</div>`).join('')}
  2629	                    </div>
  2630	                </div>
  2631	            `;
  2632	        }
  2633	
  2634	        function showAsanaDataBrowser() {
  2635	            showStatus('ðŸ“‹ Asana task browser - Opening comprehensive task management interface', 'info');
  2636	            // This will show tasks in manufacturing context with invoicing capabilities
  2637	            // Similar to Wix browser but focused on Ed's task assignments
  2638	        }
  2639	
  2640	        // Royal Mail Shipping Integration Functions
  2641	        function showShippingInterface() {
  2642	            const shippingModalHtml = `
  2643	                <div id="shippingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
  2644	                    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-3xl mx-4 border border-sage-200">
  2645	                        <div class="flex items-center justify-between mb-6">
  2646	                            <div class="flex items-center">
  2647	                                <i class="fas fa-shipping-fast text-red-600 text-2xl mr-3"></i>
  2648	                                <h2 class="text-2xl font-bold text-gray-900">Royal Mail Click & Drop</h2>
  2649	                            </div>
  2650	                            <button onclick="closeShippingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
  2651	                                <i class="fas fa-times text-xl"></i>
  2652	                            </button>
  2653	                        </div>
  2654	
  2655	                        <!-- Connection Status -->
  2656	                        <div id="shippingConnectionStatus" class="mb-6 p-4 rounded-lg border bg-green-50 border-green-200 text-green-800">
  2657	                            <div class="flex items-center">
  2658	                                <i class="fas fa-check-circle text-green-600 mr-3"></i>
  2659	                                <span class="font-medium">Connected to Royal Mail Click & Drop</span>
  2660	                            </div>
  2661	                            <p class="text-sm mt-1">API Key: 76dcfb22...567a0d â€¢ Ready to create shipments</p>
  2662	                        </div>
  2663	
  2664	                        <!-- Shipment Form -->
  2665	                        <div class="grid grid-cols-2 gap-6">
  2666	                            <!-- Left Column - Order Selection -->
  2667	                            <div>
  2668	                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Select Order</h3>
  2669	                                <div class="space-y-4">
  2670	                                    <div>
  2671	                                        <label for="wixOrderSelect" class="block text-sm font-medium text-gray-700 mb-2">Wix Order</label>
  2672	                                        <select id="wixOrderSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500"
  2673	                                                onchange="loadOrderDetails()">
  2674	                                            <option value="">Select a Wix order...</option>
  2675	                                        </select>
  2676	                                    </div>
  2677	                                    
  2678	                                    <div class="p-4 bg-blue-50 rounded-lg">
  2679	                                        <h4 class="font-medium text-blue-900 mb-2">ðŸ“¦ Full Circle Workflow:</h4>
  2680	                                        <ol class="text-xs text-blue-800 space-y-1">
  2681	                                            <li>1. Select Wix order from dropdown</li>
  2682	                                            <li>2. Generate Royal Mail shipping label</li>
  2683	                                            <li>3. Tracking automatically updates Wix order</li>
  2684	                                            <li>4. Customer gets tracking info seamlessly</li>
  2685	                                        </ol>
  2686	                                    </div>
  2687	                                </div>
  2688	                            </div>
  2689	
  2690	                            <!-- Right Column - Shipping Details -->
  2691	                            <div>
  2692	                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Shipping Details</h3>
  2693	                                <div class="space-y-4">
  2694	                                    <div class="grid grid-cols-2 gap-3">
  2695	                                        <div>
  2696	                                            <label for="recipientName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
  2697	                                            <input type="text" id="recipientName" 
  2698	                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2699	                                        </div>
  2700	                                        <div>
  2701	                                            <label for="serviceCode" class="block text-sm font-medium text-gray-700 mb-1">Service</label>
  2702	                                            <select id="serviceCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2703	                                                <option value="1st">1st Class (1-2 days)</option>
  2704	                                                <option value="2nd">2nd Class (2-3 days)</option>
  2705	                                                <option value="TPN">Tracked 48 (2 days)</option>
  2706	                                                <option value="TPL" selected>Tracked 24 (1 day)</option>
  2707	                                                <option value="SD1">Special Delivery by 1pm</option>
  2708	                                            </select>
  2709	                                        </div>
  2710	                                    </div>
  2711	
  2712	                                    <div>
  2713	                                        <label for="recipientAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
  2714	                                        <input type="text" id="recipientAddress" 
  2715	                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2716	                                    </div>
  2717	
  2718	                                    <div class="grid grid-cols-2 gap-3">
  2719	                                        <div>
  2720	                                            <label for="recipientCity" class="block text-sm font-medium text-gray-700 mb-1">City</label>
  2721	                                            <input type="text" id="recipientCity" 
  2722	                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2723	                                        </div>
  2724	                                        <div>
  2725	                                            <label for="recipientPostcode" class="block text-sm font-medium text-gray-700 mb-1">Postcode</label>
  2726	                                            <input type="text" id="recipientPostcode" 
  2727	                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2728	                                        </div>
  2729	                                    </div>
  2730	
  2731	                                    <div class="grid grid-cols-2 gap-3">
  2732	                                        <div>
  2733	                                            <label for="packageWeight" class="block text-sm font-medium text-gray-700 mb-1">Weight (g)</label>
  2734	                                            <input type="number" id="packageWeight" value="500"
  2735	                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2736	                                        </div>
  2737	                                        <div>
  2738	                                            <label for="itemDescription" class="block text-sm font-medium text-gray-700 mb-1">Contents</label>
  2739	                                            <input type="text" id="itemDescription" value="Star Seed Natural Products"
  2740	                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sage-500 text-sm">
  2741	                                        </div>
  2742	                                    </div>
  2743	                                </div>
  2744	                            </div>
  2745	                        </div>
  2746	
  2747	                        <!-- Progress Bar -->
  2748	                        <div id="shippingProgress" class="hidden my-6">
  2749	                            <div class="flex justify-between text-sm text-gray-600 mb-2">
  2750	                                <span id="shippingProgressText">Creating shipment...</span>
  2751	                                <span id="shippingProgressPercent">0%</span>
  2752	                            </div>
  2753	                            <div class="w-full bg-gray-200 rounded-full h-2">
  2754	                                <div id="shippingProgressBar" class="bg-red-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
  2755	                            </div>
  2756	                        </div>
  2757	
  2758	                        <!-- Results -->
  2759	                        <div id="shippingResults" class="hidden my-6"></div>
  2760	
  2761	                        <!-- Action Buttons -->
  2762	                        <div class="flex space-x-3 mt-6">
  2763	                            <button onclick="testRoyalMailConnection()" 
  2764	                                    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  2765	                                <i class="fas fa-plug mr-2"></i>Test Connection
  2766	                            </button>
  2767	                            <button onclick="loadWixOrdersForShipping()" 
  2768	                                    class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  2769	                                <i class="fas fa-refresh mr-2"></i>Load Orders
  2770	                            </button>
  2771	                            <button onclick="createShipment()" 
  2772	                                    class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
  2773	                                <i class="fas fa-box mr-2"></i>Create Shipment & Label
  2774	                            </button>
  2775	                            <button onclick="closeShippingModal()" 
  2776	                                    class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
  2777	                                Cancel
  2778	                            </button>
  2779	                        </div>
  2780	                    </div>
  2781	                </div>
  2782	            `;
  2783	
  2784	            document.body.insertAdjacentHTML('beforeend', shippingModalHtml);
  2785	            loadWixOrdersForShipping();
  2786	        }
  2787	
  2788	        function closeShippingModal() {
  2789	            const modal = document.getElementById('shippingModal');
  2790	            if (modal) {
  2791	                modal.remove();
  2792	            }
  2793	        }
  2794	
  2795	        async function testRoyalMailConnection() {
  2796	            showShippingStatus('Testing Royal Mail Click & Drop connection...', 'loading');
  2797	
  2798	            try {
  2799	                const response = await fetch('/.netlify/functions/royal-mail-integration', {
  2800	                    method: 'POST',
  2801	                    headers: { 'Content-Type': 'application/json' },
  2802	                    body: JSON.stringify({ action: 'test_connection' })
  2803	                });
  2804	
  2805	                const result = await response.json();
  2806	
  2807	                if (result.success) {
  2808	                    showShippingStatus(`âœ… Connected to Royal Mail! Found ${result.ordersCount || 0} existing orders`, 'success');
  2809	                } else {
  2810	                    showShippingStatus(`âŒ Connection failed: ${result.error}`, 'error');
  2811	                }
  2812	            } catch (error) {
  2813	                showShippingStatus(`âŒ Connection error: ${error.message}`, 'error');
  2814	            }
  2815	        }
  2816	
  2817	        async function loadWixOrdersForShipping() {
  2818	            try {
  2819	                // Load recent Wix orders that need shipping
  2820	                const response = await fetch('/.netlify/functions/db-query', {
  2821	                    method: 'POST',
  2822	                    headers: { 'Content-Type': 'application/json' },
  2823	                    body: JSON.stringify({
  2824	                        action: 'query',
  2825	                        query: `SELECT wix_order_id, order_number, customer_name, customer_email, 
  2826	                                       total_amount, shipping_address, date_created 
  2827	                                FROM wix_orders 
  2828	                                WHERE payment_status = 'PAID' 
  2829	                                AND wix_order_id NOT IN (SELECT wix_order_id FROM royal_mail_shipments WHERE wix_order_id IS NOT NULL)
  2830	                                ORDER BY date_created DESC LIMIT 50`
  2831	                    })
  2832	                });
  2833	
  2834	                const result = await response.json();
  2835	
  2836	                if (result.success) {
  2837	                    const orderSelect = document.getElementById('wixOrderSelect');
  2838	                    orderSelect.innerHTML = '<option value="">Select a Wix order...</option>';
  2839	
  2840	                    result.data.forEach(order => {
  2841	                        const option = document.createElement('option');
  2842	                        option.value = order.wix_order_id;
  2843	                        option.dataset.orderData = JSON.stringify(order);
  2844	                        option.textContent = `${order.order_number || order.wix_order_id} - ${order.customer_name} (Â£${parseFloat(order.total_amount || 0).toFixed(2)})`;
  2845	                        orderSelect.appendChild(option);
  2846	                    });
  2847	
  2848	                    showShippingStatus(`âœ… Loaded ${result.data.length} orders ready for shipping`, 'success');
  2849	                } else {
  2850	                    showShippingStatus(`âŒ Failed to load orders: ${result.error}`, 'error');
  2851	                }
  2852	            } catch (error) {
  2853	                showShippingStatus(`âŒ Error loading orders: ${error.message}`, 'error');
  2854	            }
  2855	        }
  2856	
  2857	        function loadOrderDetails() {
  2858	            const orderSelect = document.getElementById('wixOrderSelect');
  2859	            const selectedOption = orderSelect.options[orderSelect.selectedIndex];
  2860	
  2861	            if (selectedOption.value && selectedOption.dataset.orderData) {
  2862	                const orderData = JSON.parse(selectedOption.dataset.orderData);
  2863	                
  2864	                // Parse shipping address if available
  2865	                if (orderData.shipping_address) {
  2866	                    const address = JSON.parse(orderData.shipping_address);
  2867	                    document.getElementById('recipientName').value = orderData.customer_name || '';
  2868	                    document.getElementById('recipientAddress').value = `${address.addressLine1 || ''} ${address.addressLine2 || ''}`.trim();
  2869	                    document.getElementById('recipientCity').value = address.city || '';
  2870	                    document.getElementById('recipientPostcode').value = address.postalCode || address.zipCode || '';
  2871	                } else {
  2872	                    // Clear fields if no address data
  2873	                    document.getElementById('recipientName').value = orderData.customer_name || '';
  2874	                    document.getElementById('recipientAddress').value = '';
  2875	                    document.getElementById('recipientCity').value = '';
  2876	                    document.getElementById('recipientPostcode').value = '';
  2877	                }
  2878	            }
  2879	        }
  2880	
  2881	        async function createShipment() {
  2882	            const wixOrderId = document.getElementById('wixOrderSelect').value;
  2883	            const recipientName = document.getElementById('recipientName').value;
  2884	            const recipientAddress = document.getElementById('recipientAddress').value;
  2885	            const recipientCity = document.getElementById('recipientCity').value;
  2886	            const recipientPostcode = document.getElementById('recipientPostcode').value;
  2887	            const serviceCode = document.getElementById('serviceCode').value;
  2888	            const weight = parseInt(document.getElementById('packageWeight').value);
  2889	            const itemDescription = document.getElementById('itemDescription').value;
  2890	
  2891	            if (!wixOrderId || !recipientName || !recipientAddress || !recipientPostcode) {
  2892	                showShippingStatus('Please fill in all required fields', 'error');
  2893	                return;
  2894	            }
  2895	
  2896	            showShippingProgress(true);
  2897	            updateShippingProgress(25, 'Creating Royal Mail shipment...');
  2898	
  2899	            try {
  2900	                const response = await fetch('/.netlify/functions/royal-mail-integration', {
  2901	                    method: 'POST',
  2902	                    headers: { 'Content-Type': 'application/json' },
  2903	                    body: JSON.stringify({
  2904	                        action: 'create_shipment',
  2905	                        wixOrderId,
  2906	                        recipientName,
  2907	                        recipientAddress,
  2908	                        recipientCity,
  2909	                        recipientPostcode,
  2910	                        serviceCode,
  2911	                        weight,
  2912	                        itemDescription
  2913	                    })
  2914	                });
  2915	
  2916	                const result = await response.json();
  2917	
  2918	                updateShippingProgress(75, 'Updating Wix order with tracking...');
  2919	
  2920	                if (result.success) {
  2921	                    updateShippingProgress(100, 'Shipment created successfully!');
  2922	                    
  2923	                    const shipment = result.shipment;
  2924	                    showShippingResults([
  2925	                        `âœ… Shipment created successfully`,
  2926	                        `ðŸ“¦ Tracking Number: ${shipment.trackingNumber}`,
  2927	                        `ðŸšš Service: ${shipment.service}`,
  2928	                        `ðŸ”— Tracking URL: ${shipment.trackingUrl}`,
  2929	                        `ðŸ“„ Label: ${shipment.labelUrl ? 'Generated' : 'Pending'}`,
  2930	                        `ðŸ“± Wix Order: Automatically updated with tracking info`
  2931	                    ]);
  2932	
  2933	                    // Refresh the order list to remove the shipped order
  2934	                    setTimeout(() => {
  2935	                        loadWixOrdersForShipping();
  2936	                    }, 2000);
  2937	
  2938	                } else {
  2939	                    updateShippingProgress(0, 'Shipment creation failed');
  2940	                    showShippingResults([`âŒ Failed to create shipment: ${result.error}`]);
  2941	                }
  2942	
  2943	            } catch (error) {
  2944	                updateShippingProgress(0, 'Error creating shipment');
  2945	                showShippingResults([`âŒ Error: ${error.message}`]);
  2946	            }
  2947	        }
  2948	
  2949	        function showShippingStatus(message, type) {
  2950	            const statusDiv = document.getElementById('shippingConnectionStatus');
  2951	            const colors = {
  2952	                'success': 'bg-green-50 border-green-200 text-green-800',
  2953	                'error': 'bg-red-50 border-red-200 text-red-800',
  2954	                'loading': 'bg-blue-50 border-blue-200 text-blue-800',
  2955	                'info': 'bg-gray-50 border-gray-200 text-gray-800'
  2956	            };
  2957	
  2958	            const icons = {
  2959	                'success': 'fas fa-check-circle text-green-600',
  2960	                'error': 'fas fa-exclamation-circle text-red-600',
  2961	                'loading': 'fas fa-spinner fa-spin text-blue-600',
  2962	                'info': 'fas fa-info-circle text-gray-600'
  2963	            };
  2964	
  2965	            statusDiv.className = `mb-6 p-4 rounded-lg border ${colors[type] || colors.info}`;
  2966	            statusDiv.innerHTML = `
  2967	                <div class="flex items-center">
  2968	                    <i class="${icons[type] || icons.info} mr-3"></i>
  2969	                    <span class="font-medium">${message}</span>
  2970	                </div>
  2971	            `;
  2972	        }
  2973	
  2974	        function showShippingProgress(show) {
  2975	            document.getElementById('shippingProgress').classList.toggle('hidden', !show);
  2976	        }
  2977	
  2978	        function updateShippingProgress(percent, text) {
  2979	            document.getElementById('shippingProgressBar').style.width = `${percent}%`;
  2980	            document.getElementById('shippingProgressPercent').textContent = `${percent}%`;
  2981	            document.getElementById('shippingProgressText').textContent = text;
  2982	        }
  2983	
  2984	        function showShippingResults(results) {
  2985	            const resultsDiv = document.getElementById('shippingResults');
  2986	            resultsDiv.classList.remove('hidden');
  2987	            resultsDiv.innerHTML = `
  2988	                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
  2989	                    <h4 class="font-semibold text-green-900 mb-3">ðŸš› Shipping Results:</h4>
  2990	                    <div class="space-y-2">
  2991	                        ${results.map(result => `<div class="text-sm text-green-800">${result}</div>`).join('')}
  2992	                    </div>
  2993	                </div>
  2994	            `;
  2995	        }
  2996	
  2997	        function showShipmentBrowser() {
  2998	            showStatus('ðŸš› Opening shipment tracking browser - View all Royal Mail shipments and tracking status', 'info');
  2999	        }
  3000	
  3001	        // Test function to verify Wix integration works
  3002	        function testWixIntegration() {
  3003	            console.log('ðŸ§ª Testing Wix Integration Components:');
  3004	            console.log('âœ… syncWixData function exists:', typeof syncWixData === 'function');
  3005	            console.log('âœ… showWixSyncInterface function exists:', typeof showWixSyncInterface === 'function');
  3006	            console.log('âœ… testWixConnection function exists:', typeof testWixConnection === 'function');
  3007	            console.log('âœ… Wix integration is ready for Ed to use!');
  3008	            
  3009	            // Open the modal to demonstrate
  3010	            showWixSyncInterface();
  3011	        }
  3012	
  3013	        function generateInvoice() {
  3014	            showStatus('ðŸ“§ Auto-invoice generation - Feature in development', 'info');
  3015	        }
  3016	
  3017	        function exportInventory() {
  3018	            showStatus('ðŸ“¥ CSV export initiated - Feature in development', 'info');
  3019	        }
  3020	
  3021	        function printFormulation() {
  3022	            window.print();
  3023	        }
  3024	
  3025	        // Display Helper Functions
  3026	        function showStatus(message, type = 'info') {
  3027	            console.log(message);
  3028	            // You can add a toast notification system here
  3029	        }
  3030	
  3031	        function showDbResult(message) {
  3032	            document.getElementById('dbResults').innerHTML = `<span class="text-gray-800">${message.replace(/\n/g, '<br>')}</span>`;
  3033	        }
  3034	    </script>
  3035	</body>
  3036	</html>
